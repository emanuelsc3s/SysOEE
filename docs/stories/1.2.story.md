# Story 1.2: Configurar Supabase Cloud e Conectar Frontend

## Status
**In Progress** üîÑ

**Progresso:** 1/6 tasks conclu√≠das (17%)
**√öltima Atualiza√ß√£o:** 26 de Outubro de 2025

## Story

**Como** desenvolvedor,
**Eu quero** criar projeto Supabase Pro e conectar apps/web via Supabase JS Client,
**Para que** eu tenha backend (PostgreSQL + Auth + Realtime) funcional desde o in√≠cio.

## Acceptance Criteria

1. Projeto Supabase criado no plano Pro com nome "SysOEE-MVP"
2. Vari√°veis de ambiente `.env.local` em apps/web: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`
3. Supabase JS Client inicializado em `apps/web/src/lib/supabase.ts`
4. Health-check query: `SELECT 1` executado com sucesso no mount do App.tsx
5. Logs de conex√£o exibidos no console (URL do projeto, status connected)
6. Service Role Key armazenada em vari√°vel de ambiente (N√ÉO commitada no Git)
7. Documenta√ß√£o em README.md com passo-a-passo para obter keys do dashboard Supabase

## Tasks / Subtasks

- [x] **Task 1: Criar Projeto Supabase Pro** (AC: 1) ‚úÖ
  - [x] Acessar https://supabase.com/dashboard
  - [x] Criar novo projeto: nome "SICFAR", regi√£o South America (S√£o Paulo)
  - [x] Anotar: Project URL, ANON_KEY, SERVICE_ROLE_KEY
  - [x] Configurar plano Pro (se necess√°rio)

- [ ] **Task 2: Configurar Vari√°veis de Ambiente** (AC: 2, 6)
  - [ ] Criar arquivo `apps/web/.env.local`
  - [ ] Adicionar `VITE_SUPABASE_URL=https://xxx.supabase.co`
  - [ ] Adicionar `VITE_SUPABASE_ANON_KEY=eyJxxx...`
  - [ ] Adicionar `SUPABASE_SERVICE_ROLE_KEY=eyJxxx...` (backend only)
  - [ ] Verificar que `.env.local` est√° no .gitignore
  - [ ] Criar `.env.example` com placeholders (para documenta√ß√£o)

- [ ] **Task 3: Instalar Supabase Client** (AC: 3)
  - [ ] `cd apps/web && npm install @supabase/supabase-js`
  - [ ] Criar arquivo `apps/web/src/lib/supabase.ts`
  - [ ] Inicializar client com createClient()
  - [ ] Configurar `autoRefreshToken: true` (para Story 1.6)

- [ ] **Task 4: Implementar Health-Check de Conex√£o** (AC: 4, 5)
  - [ ] Criar fun√ß√£o `testConnection()` em supabase.ts
  - [ ] Executar `SELECT 1` no mount do App.tsx (useEffect)
  - [ ] Logar no console: URL do projeto, status
  - [ ] Tratar erros de conex√£o gracefully

- [ ] **Task 5: Documentar Setup em README.md** (AC: 7)
  - [ ] Adicionar se√ß√£o "Configura√ß√£o Supabase"
  - [ ] Passo-a-passo: como obter keys do dashboard
  - [ ] Screenshot do dashboard (opcional)
  - [ ] Troubleshooting comum (CORS, keys inv√°lidas)

- [ ] **Task 6: Testar Conex√£o Local**
  - [ ] `npm run dev` em apps/web
  - [ ] Verificar console: "Supabase connected: https://xxx.supabase.co"
  - [ ] Verificar que n√£o h√° erros de CORS
  - [ ] Testar com keys inv√°lidas (deve mostrar erro claro)

## Dev Notes

### Previous Story Insights
**Story Anterior:** 1.1 (Setup Turborepo)
- Turborepo j√° configurado e `turbo dev` funcionando
- apps/web existe e exibe "Hello World"
- Agora vamos conectar ao backend Supabase

### Supabase Configuration

**Client Initialization:**
```typescript
// apps/web/src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true
  }
})

// Health-check function
export async function testConnection() {
  try {
    const { data, error } = await supabase.rpc('test', {})
    if (error) throw error
    console.log('‚úÖ Supabase connected:', supabaseUrl)
    return true
  } catch (error) {
    console.error('‚ùå Supabase connection failed:', error)
    return false
  }
}
```

**Environment Variables (.env.local):**
```bash
# Supabase Configuration
VITE_SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**IMPORTANTE:**
- `VITE_SUPABASE_ANON_KEY` √© seguro expor no frontend (rate-limited)
- `SUPABASE_SERVICE_ROLE_KEY` NUNCA deve ser exposto (bypass RLS)
- Prefixo `VITE_` necess√°rio para Vite expor vari√°vel ao frontend

### Supabase Dashboard

**Como obter keys:**
1. Acessar https://supabase.com/dashboard
2. Selecionar projeto "SysOEE-MVP"
3. Settings ‚Üí API
4. Copiar:
   - Project URL
   - anon public key
   - service_role key (‚ö†Ô∏è CUIDADO - n√£o committar)

### Testing

**Teste Manual:**
1. Abrir http://localhost:5173
2. Verificar console do browser
3. Deve aparecer: "‚úÖ Supabase connected: https://xxx.supabase.co"
4. Se erro: verificar keys, CORS, plano Supabase ativo

**Troubleshooting Comum:**
- **CORS Error:** Verificar que projeto Supabase est√° ativo
- **Invalid API Key:** Verificar que copiou ANON_KEY correto
- **Module not found:** Executar `npm install` novamente

### Architecture Context

**[Fonte: docs/architecture/backend-architecture.md]**

O Supabase fornece:
- **PostgreSQL Database** - Banco de dados principal
- **PostgREST API** - API REST auto-gerada
- **Realtime Server** - Subscriptions em tempo real
- **Auth Service** - Autentica√ß√£o (ser√° usado na Story 1.3)
- **Storage** - Armazenamento de arquivos (futuro)

### Security Notes

**RLS (Row Level Security):**
- Ser√° configurado no Epic 2, Story 2.2
- Por enquanto, tabelas estar√£o abertas (apenas para dev)
- NUNCA usar SERVICE_ROLE_KEY no frontend

**Rate Limiting:**
- Supabase Pro: 500 requests/second
- ANON_KEY: rate-limited automaticamente
- SERVICE_ROLE_KEY: sem rate limit (usar com cuidado)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-26 | 1.0 | Hist√≥ria criada | Sarah (Product Owner) |
| 2025-10-26 | 1.1 | Task 1 conclu√≠da - Projeto Supabase criado | Emanuel (Developer) |

---

## Dev Agent Record

### Agent Model Used
**Desenvolvedor:** Emanuel
**Status:** Em andamento (Task 1/6 conclu√≠da)

### Debug Log References
Nenhum issue cr√≠tico at√© o momento.

### Completion Notes

**‚úÖ Task 1 Conclu√≠da (26/10/2025):**

**Projeto Supabase Criado:**
- ‚úÖ Nome: "SICFAR"
- ‚úÖ Regi√£o: South America (S√£o Paulo)
- ‚úÖ Plano: Configurado conforme necess√°rio
- ‚úÖ Credenciais anotadas:
  - Project URL: `https://[project-id].supabase.co`
  - ANON_KEY: Obtida do dashboard
  - SERVICE_ROLE_KEY: Obtida do dashboard (‚ö†Ô∏è segredo)

**Observa√ß√µes:**
- Projeto criado com sucesso no dashboard Supabase
- Keys anotadas em local seguro (n√£o commitadas)
- Pronto para Task 2: configurar vari√°veis de ambiente

**Pr√≥ximos Passos:**
- Task 2: Criar `.env.local` com as credenciais
- Task 3: Instalar `@supabase/supabase-js`
- Task 4: Implementar health-check de conex√£o

### File List

**Arquivos Criados (Task 1):**
_Nenhum arquivo de c√≥digo criado ainda - apenas projeto Supabase no dashboard_

**Arquivos Pendentes (Tasks 2-6):**
- `.env.local` - Vari√°veis de ambiente (Task 2)
- `src/lib/supabase.ts` - Client Supabase (Task 3)
- `README.md` - Atualiza√ß√£o com instru√ß√µes Supabase (Task 5)

---

## QA Results

**Status:** ‚è≥ **Pendente**

_QA ser√° executado ap√≥s conclus√£o de todas as tasks (6/6)._

**Tasks Conclu√≠das:** 1/6
- ‚úÖ Task 1: Projeto Supabase criado

**Tasks Pendentes:** 5/6
- ‚è≥ Task 2: Vari√°veis de ambiente
- ‚è≥ Task 3: Instalar Supabase Client
- ‚è≥ Task 4: Health-check de conex√£o
- ‚è≥ Task 5: Documenta√ß√£o README
- ‚è≥ Task 6: Testes locais
