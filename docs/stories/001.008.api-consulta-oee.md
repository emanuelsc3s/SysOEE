# Story 001.008: API de Consulta de OEE

## Status
Draft

## Story

**As a** desenvolvedor de dashboards,
**I want** uma API TypeScript para consultar dados históricos de OEE,
**so that** possa criar dashboards, gráficos e relatórios consumindo dados da tabela tboee.

## Acceptance Criteria

1. Arquivo `src/services/api/oee.api.ts` criado
2. Arquivo `src/types/oee.ts` criado com tipos completos
3. Function `buscarOEEPorLote(lote_id: string): Promise<OEECalculado | null>` implementada
4. Function `buscarOEEPorLinha(linhaproducao_id: number, periodo: Periodo): Promise<OEECalculado[]>` implementada
5. Function `buscarOEEPorDepartamento(departamento_id: number, periodo: Periodo): Promise<OEECalculado[]>` implementada
6. Function `buscarComponentesOEE(filtros: FiltroOEE): Promise<ComponentesOEE>` implementada retornando médias de disponibilidade, performance, qualidade
7. Function `buscarTendenciasOEE(linhaproducao_id: number, semanas: number): Promise<TendenciaOEE[]>` implementada agrupando por semana
8. Todas as queries filtram apenas registros com status = 'ATIVO'
9. Período implementado com data_inicio e data_fim
10. Tipos mapeiam corretamente estrutura de tboee
11. Erros tratados e re-lançados com mensagens claras
12. Testes manuais executados com sucesso

## Tasks / Subtasks

- [ ] Criar tipos (AC: 2, 10)
  - [ ] Criar src/types/oee.ts
  - [ ] interface OEECalculado (todos os campos de tboee)
  - [ ] interface Periodo { data_inicio: string, data_fim: string }
  - [ ] interface FiltroOEE
  - [ ] interface ComponentesOEE { disponibilidade, performance, qualidade, oee }
  - [ ] interface TendenciaOEE { semana, oee, disponibilidade, ... }

- [ ] Criar API base (AC: 1)
  - [ ] Criar src/services/api/oee.api.ts
  - [ ] Import supabase, types

- [ ] Implementar buscarOEEPorLote (AC: 3, 8)
  - [ ] SELECT * FROM tboee WHERE lote_id = ? AND status = 'ATIVO' LIMIT 1
  - [ ] Return data || null

- [ ] Implementar buscarOEEPorLinha (AC: 4, 8, 9)
  - [ ] SELECT * FROM tboee WHERE linhaproducao_id = ? AND status = 'ATIVO'
  - [ ] .gte('data_referencia', periodo.data_inicio)
  - [ ] .lte('data_referencia', periodo.data_fim)
  - [ ] .order('data_referencia')

- [ ] Implementar buscarOEEPorDepartamento (AC: 5, 8, 9)
  - [ ] Similar ao anterior, filtro por departamento_id

- [ ] Implementar buscarComponentesOEE (AC: 6, 8)
  - [ ] Buscar registros com filtros
  - [ ] Calcular AVG de disponibilidade, performance, qualidade, oee
  - [ ] Return { disponibilidade: avg(...), ... }

- [ ] Implementar buscarTendenciasOEE (AC: 7, 8)
  - [ ] Buscar últimas N semanas
  - [ ] GROUP BY semana (usar DATE_TRUNC ou similar)
  - [ ] AVG de cada componente por semana
  - [ ] Return array ordenado por semana

- [ ] Tratamento de erros (AC: 11)
  - [ ] Capturar erros do Supabase
  - [ ] Lançar com mensagem clara

- [ ] Testar (AC: 12)
  - [ ] Testar cada função
  - [ ] Validar tipos TypeScript
  - [ ] Validar que queries retornam dados corretos

## Dev Notes

### Example Queries

```typescript
// OEE por lote
const oee = await buscarOEEPorLote('uuid-123');
console.log(oee.oee, oee.disponibilidade);

// OEE de uma linha no mês
const oees = await buscarOEEPorLinha(1, {
  data_inicio: '2025-11-01',
  data_fim: '2025-11-30'
});

// Tendências (últimas 10 semanas)
const tendencias = await buscarTendenciasOEE(1, 10);
tendencias.forEach(t => console.log(t.semana, t.oee));
```

### Aggregation Pattern

```typescript
// Componentes médios
const { data } = await supabase
  .from('tboee')
  .select('disponibilidade, performance, qualidade, oee')
  .eq('status', 'ATIVO')
  .gte('data_referencia', '...');

const avg = {
  disponibilidade: data.reduce((a, b) => a + b.disponibilidade, 0) / data.length,
  // ...
};
```

## Change Log
| Date       | Version | Description | Author |
|------------|---------|-------------|--------|
| 2025-11-16 | 1.0     | Story criada| Sarah  |
