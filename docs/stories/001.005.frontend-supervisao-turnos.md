# Story 001.005: Frontend - Página de Supervisão de Turnos

## Status
Draft

## Story

**As a** supervisor de produção,
**I want** uma página onde visualizo todos os turnos do dia e posso selecion um para ver detalhes e fechar,
**so that** possa conferir apontamentos e disparar cálculo automático de OEE ao final do turno.

## Acceptance Criteria

1. Página `src/pages/SupervisaoTurnos.tsx` criada acessível via rota `/supervisao-turnos`
2. Header exibe título "Supervisão de Turnos" e data selecionada formatada em português
3. Cards de resumo exibem total de turnos, turnos abertos e turnos fechados
4. Componente `FiltrosSupervisao` permite filtrar por data, linha e status
5. Tabela de turnos exibe: Linha, Turno, Produto, Horário, Status, Paradas (qtd e tempo), Produção (unidades), Refugo, OEE Estimado, Ações
6. Badge de status com cores: Aberto (amarelo), Fechado (verde), Planejado (cinza), Cancelado (vermelho)
7. Linhas com paradas ativas destacadas em amarelo claro
8. Botão "Fechar Turno" habilitado apenas se turno está aberto E não há paradas ativas
9. Modal de detalhes (`ModalDetalhesTurno`) abre ao clicar no botão de ação
10. Modal exibe 3 abas: Paradas, Produção, Qualidade com listas detalhadas de apontamentos
11. Modal exibe alertas se há paradas ativas (bloqueia fechamento)
12. Campo de observações do supervisor no modal (opcional)
13. Dialog de confirmação antes de fechar turno
14. Ao confirmar fechamento: chama API, exibe loading, fecha modal e atualiza lista em caso de sucesso
15. Mensagem de erro clara se fechamento falhar (ex: sem velocidade cadastrada)
16. Dados atualizam automaticamente a cada 30 segundos (refetchInterval)
17. UI segue padrões do projeto (Tailwind + Shadcn/UI)
18. Responsivo e funcional em desktop (mobile não é escopo)

## Tasks / Subtasks

- [ ] Criar página principal (AC: 1, 2, 3, 4, 16)
  - [ ] Criar src/pages/SupervisaoTurnos.tsx
  - [ ] Import hooks (useState, useQuery from @tanstack/react-query)
  - [ ] Import API (buscarTurnosDoDia, buscarResumoTurnos)
  - [ ] State: filtros (data, linhaproducao_id?, departamento_id?, status?)
  - [ ] State: turnoSelecionado, modalAberto
  - [ ] useQuery para turnos com refetchInterval: 30000
  - [ ] useQuery para resumo
  - [ ] Header com título e data formatada (date-fns)
  - [ ] ResumoCards component
  - [ ] FiltrosSupervisao component
  - [ ] TabelaTurnos component
  - [ ] ModalDetalhesTurno component

- [ ] Criar componente TabelaTurnos (AC: 5, 6, 7, 8)
  - [ ] Criar src/components/supervisao/TabelaTurnos.tsx
  - [ ] Props: turnos, onSelecionarTurno
  - [ ] Table com colunas conforme AC 5
  - [ ] Badge de status com variant conforme AC 6
  - [ ] Highlight com bg-yellow-50 se paradas_em_andamento > 0 (AC 7)
  - [ ] Botão "Fechar Turno" disabled se turno fechado OU paradas ativas (AC 8)
  - [ ] Click no botão → onSelecionarTurno(turno)

- [ ] Criar componente ModalDetalhesTurno (AC: 9, 10, 11, 12, 13, 14, 15)
  - [ ] Criar src/components/supervisao/ModalDetalhesTurno.tsx
  - [ ] Props: turno, aberto, onFechar, onTurnoFechado
  - [ ] useQuery buscarDetalhesApontamentos quando modal abre
  - [ ] DialogHeader com título do turno
  - [ ] Cards de resumo (Paradas, Produção, Refugo, Retrabalho)
  - [ ] Alert se paradas_em_andamento > 0 (AC 11)
  - [ ] Tabs (Paradas, Produção, Qualidade) com listas (AC 10)
  - [ ] Textarea para observações do supervisor (AC 12)
  - [ ] Botão "Fechar Turno" → abre dialog de confirmação (AC 13)
  - [ ] Dialog de confirmação com useMutation fecharTurno (AC 14)
  - [ ] Loading state durante fechamento
  - [ ] onSuccess → onTurnoFechado() para atualizar lista
  - [ ] onError → exibir mensagem clara (AC 15)

- [ ] Criar componente FiltrosSupervisao
  - [ ] Criar src/components/supervisao/FiltrosSupervisao.tsx
  - [ ] Props: filtros, onChange
  - [ ] Input de data (type="date")
  - [ ] Select de linha (buscar de tblinhaproducao ou hardcoded?)
  - [ ] Select de departamento (buscar ou hardcoded?)
  - [ ] Select de status (ABERTO, FECHADO, TODOS)

- [ ] Criar componente ResumoCards
  - [ ] Criar src/components/supervisao/ResumoCards.tsx
  - [ ] Props: resumo (total, abertos, fechados)
  - [ ] 3 cards lado a lado
  - [ ] Ícones e cores diferenciadas

- [ ] Adicionar rota (AC: 1)
  - [ ] Editar src/App.tsx ou arquivo de rotas
  - [ ] Adicionar <Route path="/supervisao-turnos" element={<SupervisaoTurnos />} />

- [ ] Estilização e responsividade (AC: 17, 18)
  - [ ] Usar Tailwind classes conforme docs/design/estilizacao-CRUD.md
  - [ ] Usar componentes Shadcn/UI (Badge, Button, Dialog, Tabs, Alert, Textarea)
  - [ ] Testar em desktop (1920x1080, 1366x768)

- [ ] Testar fluxo completo (AC: todos)
  - [ ] Acessar /supervisao-turnos
  - [ ] Verificar que turnos do dia carregam
  - [ ] Filtrar por linha → lista atualiza
  - [ ] Selecionar turno → modal abre
  - [ ] Ver abas de paradas/produção/qualidade
  - [ ] Tentar fechar com parada ativa → botão desabilitado
  - [ ] Finalizar parada ativa
  - [ ] Fechar turno → confirmação → sucesso
  - [ ] Lista atualiza automaticamente

## Dev Notes

### Relevant Source Tree
```
src/
├── pages/
│   ├── Operacao.tsx                         # Exemplo de página existente
│   └── SupervisaoTurnos.tsx                 # ⭐ A ser criado
├── components/
│   ├── operacao/                            # Exemplos existentes
│   │   └── ModalApontamentoParada.tsx
│   ├── supervisao/                          # ⭐ A ser criado (pasta nova)
│   │   ├── TabelaTurnos.tsx
│   │   ├── ModalDetalhesTurno.tsx
│   │   ├── FiltrosSupervisao.tsx
│   │   └── ResumoCards.tsx
│   └── ui/                                  # Shadcn/UI components (já existem)
├── services/api/
│   └── supervisao.api.ts                    # Criado na Story 4
└── types/
    └── supervisao.ts                        # Criado na Story 4
```

### UI Components (Shadcn/UI)

Já disponíveis no projeto:
- `<Badge variant="warning|success|destructive|secondary">`
- `<Button variant="outline|default" size="sm">`
- `<Dialog>`, `<DialogContent>`, `<DialogHeader>`, `<DialogTitle>`, `<DialogFooter>`
- `<Tabs>`, `<TabsList>`, `<TabsTrigger>`, `<TabsContent>`
- `<Alert variant="warning">`, `<AlertDescription>`
- `<Textarea>`

### Date Formatting

```typescript
import { format } from 'date-fns';
import { ptBR } from 'date-fns/locale';

format(new Date(filtros.data), "EEEE, dd 'de' MMMM 'de' yyyy", { locale: ptBR })
// Output: "Sexta-feira, 16 de novembro de 2025"
```

### React Query Pattern

```typescript
const { data: turnos, isLoading, error, refetch } = useQuery({
  queryKey: ['supervisao-turnos', filtros],
  queryFn: () => buscarTurnosDoDia(filtros),
  refetchInterval: 30000  // 30 segundos
});
```

### Mutation Pattern

```typescript
const mutationFechar = useMutation({
  mutationFn: () => fecharTurno(turno.lote_id, 1, observacoes),
  onSuccess: () => {
    onTurnoFechado();  // Callback para atualizar lista
  },
  onError: (error) => {
    // Exibir mensagem de erro
  }
});
```

### Exemplo de Estrutura do Modal

```typescript
<Dialog open={aberto} onOpenChange={onFechar}>
  <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
    <DialogHeader>
      <DialogTitle>Detalhes do Turno - {turno.linha_nome}</DialogTitle>
    </DialogHeader>

    {/* Resumo */}
    <div className="grid grid-cols-4 gap-4">
      {/* Cards */}
    </div>

    {/* Tabs */}
    <Tabs defaultValue="paradas">
      <TabsList>
        <TabsTrigger value="paradas">Paradas ({detalhes.paradas.length})</TabsTrigger>
        {/* ... */}
      </TabsList>
      <TabsContent value="paradas">
        {/* Lista de paradas */}
      </TabsContent>
    </Tabs>

    {/* Observações */}
    <Textarea value={observacoes} onChange={...} />

    <DialogFooter>
      <Button onClick={handleFecharTurno}>Fechar Turno</Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

### Testing Standards

**Manual Testing:**

1. **Rendering:**
   - [ ] Página renderiza sem erros
   - [ ] Componentes carregam corretamente

2. **Data Loading:**
   - [ ] Turnos do dia carregam
   - [ ] Resumo exibe contadores corretos
   - [ ] Auto-refresh funciona (verificar network tab a cada 30s)

3. **Filtros:**
   - [ ] Mudar data → turnos atualizam
   - [ ] Filtrar por linha → lista filtra
   - [ ] Filtrar por status ABERTO → apenas abertos exibidos

4. **Tabela:**
   - [ ] Todas colunas exibindo dados corretos
   - [ ] Badge de status com cor correta
   - [ ] Linhas com paradas ativas destacadas
   - [ ] Botão desabilitado quando apropriado

5. **Modal:**
   - [ ] Modal abre ao clicar
   - [ ] Detalhes carregam
   - [ ] Abas funcionam
   - [ ] Dados corretos em cada aba

6. **Fechamento:**
   - [ ] Confirmação exibida
   - [ ] Loading state exibe
   - [ ] Sucesso → modal fecha + lista atualiza
   - [ ] Erro → mensagem clara exibida

7. **Edge Cases:**
   - [ ] Sem turnos → mensagem "Nenhum turno encontrado"
   - [ ] Sem apontamentos → abas exibem "Nenhum..."
   - [ ] Erro de network → mensagem de erro

## Change Log

| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-11-16 | 1.0     | Story criada                         | Sarah  |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
