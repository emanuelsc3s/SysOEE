# Story 001.001: Migration - Tabela tboee (Snapshot de OEE)

## Status
Draft

## Story

**As a** desenvolvedor do sistema OEE,
**I want** criar a migration da tabela tboee com estrutura completa para armazenar snapshots históricos de OEE,
**so that** possamos persistir dados calculados de OEE de forma imutável e com rastreabilidade ALCOA+.

## Acceptance Criteria

1. Tabela `tboee` criada com todos os campos conforme especificação em `database/migrations/09-tboee-snapshot.sql`
2. Campos de dimensões (linhaproducao_id, produto_id, turno_id, departamento_id, data_referencia) implementados corretamente
3. Campos de tempos (em minutos) implementados: tempo_calendario_minutos, tempo_paradas_estrategicas_minutos, tempo_paradas_planejadas_minutos, tempo_paradas_nao_planejadas_minutos, tempo_pequenas_paradas_minutos, tempo_retrabalho_minutos
4. Campos calculados via GENERATED ALWAYS AS STORED implementados para: tempo_disponivel_minutos, tempo_operacao_minutos, tempo_operacional_liquido_minutos, tempo_valioso_minutos
5. Campos de unidades implementados: unidades_produzidas, unidades_boas, unidades_refugadas, unidades_retrabalhadas
6. Campos de componentes OEE calculados via GENERATED ALWAYS AS STORED: disponibilidade, performance, qualidade_unidades, qualidade_retrabalho, qualidade, oee, atingiu_meta
7. Campos de snapshot (velocidade_nominal, meta_oee) implementados para preservar valores vigentes
8. Campos de metadados (calculo_tipo, status, invalidado_em, etc.) implementados para rastreabilidade
9. Campos de auditoria ALCOA+ (created_at, created_by, updated_at, updated_by, deleted_at, deleted_by) implementados
10. Constraints implementados: CHECK (unidades_boas <= unidades_produzidas), CHECK para valores positivos, UNIQUE para evitar duplicatas
11. Índices criados para otimização: idx_tboee_linha_data, idx_tboee_departamento_data, idx_tboee_status, idx_tboee_calculado_em
12. Rules implementadas para APPEND-ONLY: tboee_no_update, tboee_no_delete (bloqueiam UPDATE e DELETE)
13. Comentários (COMMENT ON) adicionados em tabela e colunas principais
14. Migration executada com sucesso no Supabase sem erros
15. Fórmulas de cálculo nos campos GENERATED validadas contra especificação (docs/project/05-Metodologia-Calculo.md)

## Tasks / Subtasks

- [ ] Preparar ambiente e validar pre-requisitos (AC: 14)
  - [ ] Conectar no Supabase do projeto
  - [ ] Verificar que migrations anteriores (01-08) foram executadas
  - [ ] Verificar que ENUMs necessários existem (tipo_linha_enum, fonte_dados_enum, etc.)

- [ ] Criar estrutura base da tabela (AC: 1, 2)
  - [ ] Definir tabela `tboee` com PK oee_id INTEGER IDENTITY
  - [ ] Adicionar campos de dimensões (linhaproducao_id, produto_id, turno_id, departamento_id, data_referencia, hora_inicio, hora_fim)
  - [ ] Adicionar FKs para tblinhaproducao, tbproduto, tbturno, tbdepartamento

- [ ] Implementar campos de snapshot de parâmetros (AC: 7)
  - [ ] Campo velocidade_nominal NUMERIC(10,2) NOT NULL
  - [ ] Campo velocidade_fonte TEXT
  - [ ] Campo meta_oee NUMERIC(5,2)

- [ ] Implementar campos de tempos (AC: 3)
  - [ ] tempo_calendario_minutos INTEGER NOT NULL CHECK >= 0
  - [ ] tempo_paradas_estrategicas_minutos INTEGER DEFAULT 0 CHECK >= 0
  - [ ] tempo_paradas_planejadas_minutos INTEGER DEFAULT 0 CHECK >= 0
  - [ ] tempo_paradas_nao_planejadas_minutos INTEGER DEFAULT 0 CHECK >= 0
  - [ ] tempo_pequenas_paradas_minutos INTEGER DEFAULT 0 CHECK >= 0
  - [ ] tempo_retrabalho_minutos INTEGER DEFAULT 0 CHECK >= 0

- [ ] Implementar campos de tempos calculados via GENERATED (AC: 4, 15)
  - [ ] tempo_disponivel_minutos = calendario - estrategicas
  - [ ] tempo_operacao_minutos = calendario - estrategicas - planejadas - nao_planejadas
  - [ ] tempo_operacional_liquido_minutos = operacao - pequenas_paradas
  - [ ] tempo_valioso_minutos = operacional_liquido - retrabalho
  - [ ] Validar fórmulas contra docs/project/05-Metodologia-Calculo.md linhas 35-45

- [ ] Implementar campos de unidades (AC: 5)
  - [ ] unidades_produzidas INTEGER NOT NULL DEFAULT 0 CHECK >= 0
  - [ ] unidades_boas INTEGER NOT NULL DEFAULT 0 CHECK >= 0
  - [ ] unidades_refugadas INTEGER DEFAULT 0 CHECK >= 0
  - [ ] unidades_retrabalhadas INTEGER DEFAULT 0 CHECK >= 0

- [ ] Implementar campos de componentes OEE calculados (AC: 6, 15)
  - [ ] disponibilidade NUMERIC(5,2) GENERATED = (tempo_operacao / tempo_disponivel) × 100
  - [ ] performance NUMERIC(5,2) GENERATED = (tempo_operacional_liquido / tempo_operacao) × 100
  - [ ] qualidade_unidades NUMERIC(5,2) GENERATED = (unidades_boas / unidades_produzidas) × 100
  - [ ] qualidade_retrabalho NUMERIC(5,2) GENERATED = ((tempo_operacao - tempo_retrabalho) / tempo_operacao) × 100
  - [ ] qualidade NUMERIC(5,2) GENERATED = qualidade_unidades × qualidade_retrabalho / 100
  - [ ] oee NUMERIC(5,2) GENERATED = disponibilidade × performance × qualidade / 10000
  - [ ] atingiu_meta BOOLEAN GENERATED = oee >= meta_oee
  - [ ] Validar todas as fórmulas contra docs/project/05-Metodologia-Calculo.md linhas 50-105

- [ ] Implementar campos de metadados (AC: 8)
  - [ ] calculo_tipo TEXT NOT NULL DEFAULT 'AUTOMATICO'
  - [ ] calculo_observacao TEXT
  - [ ] calculado_em TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (now() AT TIME ZONE 'America/Fortaleza')
  - [ ] calculado_por INTEGER REFERENCES tbusuario(usuario_id)
  - [ ] status TEXT NOT NULL DEFAULT 'ATIVO'
  - [ ] invalidado_em, invalidado_por, invalidado_motivo
  - [ ] corrigido_por_oee_id INTEGER REFERENCES tboee(oee_id)

- [ ] Implementar campos de auditoria ALCOA+ (AC: 9)
  - [ ] deletado TEXT DEFAULT 'N'
  - [ ] sync TEXT DEFAULT 'N'
  - [ ] sync_data TIMESTAMP WITHOUT TIME ZONE
  - [ ] created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (now() AT TIME ZONE 'America/Fortaleza')
  - [ ] created_by INTEGER REFERENCES tbusuario(usuario_id)
  - [ ] updated_at TIMESTAMP WITHOUT TIME ZONE
  - [ ] updated_by INTEGER REFERENCES tbusuario(usuario_id)
  - [ ] deleted_at TIMESTAMP WITHOUT TIME ZONE
  - [ ] deleted_by INTEGER REFERENCES tbusuario(usuario_id)

- [ ] Implementar constraints (AC: 10)
  - [ ] CONSTRAINT tboee_pkey PRIMARY KEY (oee_id)
  - [ ] CONSTRAINT ck_unidades_boas CHECK (unidades_boas <= unidades_produzidas)
  - [ ] CONSTRAINT ck_unidades_perdas CHECK ((unidades_refugadas + unidades_retrabalhadas) <= unidades_produzidas)
  - [ ] CONSTRAINT ck_horario_oee CHECK (hora_fim IS NULL OR hora_fim >= hora_inicio)
  - [ ] CONSTRAINT uq_oee_periodo UNIQUE (linhaproducao_id, data_referencia, turno_id, hora_inicio)

- [ ] Criar índices para performance (AC: 11)
  - [ ] CREATE INDEX idx_tboee_linha_data ON tboee(linhaproducao_id, data_referencia)
  - [ ] CREATE INDEX idx_tboee_departamento_data ON tboee(departamento_id, data_referencia)
  - [ ] CREATE INDEX idx_tboee_produto ON tboee(produto_id)
  - [ ] CREATE INDEX idx_tboee_turno ON tboee(turno_id)
  - [ ] CREATE INDEX idx_tboee_lote ON tboee(lote_id)
  - [ ] CREATE INDEX idx_tboee_status ON tboee(status) WHERE status = 'ATIVO'
  - [ ] CREATE INDEX idx_tboee_calculado_em ON tboee(calculado_em)
  - [ ] CREATE INDEX idx_tboee_atingiu_meta ON tboee(atingiu_meta) WHERE atingiu_meta IS NOT NULL

- [ ] Implementar regras APPEND-ONLY (AC: 12)
  - [ ] CREATE RULE tboee_no_update AS ON UPDATE TO tboee DO INSTEAD NOTHING
  - [ ] CREATE RULE tboee_no_delete AS ON DELETE TO tboee DO INSTEAD NOTHING
  - [ ] Adicionar comentários explicativos nas rules

- [ ] Adicionar comentários de documentação (AC: 13)
  - [ ] COMMENT ON TABLE tboee
  - [ ] COMMENT ON COLUMN tboee.oee_id
  - [ ] COMMENT ON COLUMN tboee.velocidade_nominal (explicar que é snapshot)
  - [ ] COMMENT ON COLUMN tboee.meta_oee (explicar que é snapshot)
  - [ ] COMMENT ON COLUMN tboee.calculo_tipo
  - [ ] COMMENT ON COLUMN tboee.status
  - [ ] COMMENT ON COLUMN tboee.corrigido_por_oee_id

- [ ] Executar migration e validar (AC: 14, 15)
  - [ ] Executar script 09-tboee-snapshot.sql no Supabase
  - [ ] Verificar que tabela foi criada sem erros
  - [ ] Validar estrutura via `\d tboee`
  - [ ] Validar índices via `\di tboee*`
  - [ ] Validar rules via `\d+ tboee`
  - [ ] Testar INSERT de registro de exemplo (sucesso)
  - [ ] Testar UPDATE de registro (deve falhar - rule bloqueando)
  - [ ] Testar DELETE de registro (deve falhar - rule bloqueando)
  - [ ] Validar que campos GENERATED são calculados corretamente

## Dev Notes

### Relevant Source Tree
```
database/migrations/
├── 01-enums.sql              # ENUMs já criados (tipo_linha_enum, etc.)
├── 02-tables.sql             # Tabelas base (tblinhaproducao, tbproduto, etc.)
├── 08-tbfuncionario.sql      # Tabela de funcionários
└── 09-tboee-snapshot.sql     # ⭐ ESTE ARQUIVO (a ser criado nesta story)
```

### Database Conventions
- **Nomenclatura:** Seguir padrão do projeto (docs/architecture/database-conventions.md)
- **IDs:** INTEGER GENERATED BY DEFAULT AS IDENTITY (não UUID)
- **Timestamps:** TIMESTAMP WITH TIME ZONE para auditoria, America/Fortaleza
- **Flags:** TEXT com valores 'S'/'N' ou 'Sim'/'Não'
- **FKs:** Referenciar tbusuario(usuario_id) não tbusuario(id)

### ALCOA+ Compliance
Esta tabela é CRÍTICA para compliance farmacêutico (BPF):
- **Atribuível:** calculado_por registra quem calculou
- **Legível:** Todos os dados em colunas tipadas
- **Contemporâneo:** calculado_em registra quando foi feito
- **Original:** Snapshot preserva dados originais (velocidade, meta)
- **Exato:** Cálculos validados e armazenados
- **Completo:** Todos os dados necessários presentes
- **Consistente:** Constraints garantem integridade
- **Durável:** APPEND-ONLY garante imutabilidade
- **Disponível:** Índices garantem performance de consulta

### Formulas de OEE (CRÍTICO)
Conforme `docs/project/05-Metodologia-Calculo.md`:

**Tempos:**
```
Tempo Disponível = Tempo Calendário - Paradas Estratégicas
Tempo Operação = Tempo Disponível - Paradas Planejadas - Paradas Não Planejadas
Tempo Operacional Líquido = Tempo Operação - Pequenas Paradas
Tempo Valioso = Tempo Operacional Líquido - Tempo Retrabalho
```

**Componentes:**
```
Disponibilidade (%) = (Tempo Operação / Tempo Disponível) × 100
Performance (%) = (Tempo Op. Líquido / Tempo Operação) × 100
Qualidade_Unidades (%) = (Unidades Boas / Unidades Produzidas) × 100
Qualidade_Retrabalho (%) = ((Tempo Operação - Tempo Retrabalho) / Tempo Operação) × 100
Qualidade (%) = Qualidade_Unidades × Qualidade_Retrabalho / 100
OEE (%) = Disponibilidade × Performance × Qualidade / 10000
```

**Casos Especiais:**
- Se Tempo Disponível = 0, Disponibilidade = 0
- Se Tempo Operação = 0, Performance = 0
- Se Unidades Produzidas = 0, Qualidade_Unidades = 100
- Usar NULLIF para evitar divisão por zero

### Important Notes from Previous Work
- Migration 08-tbfuncionario.sql foi criada e documenta estrutura de funcionários
- Convenção de TEXT ao invés de BOOLEAN foi estabelecida
- Timezone padrão é 'America/Fortaleza' (UTC-3)
- Campo lote_id pode ser NULL (para futuras expansões)

### Testing Standards

**Test file location:**
- Não aplicável (migration SQL, testar manualmente)

**Testing approach:**
1. **Teste de Estrutura:**
   - Executar migration em ambiente de dev
   - Validar via `\d tboee` que todos os campos existem
   - Validar tipos de dados

2. **Teste de INSERT:**
   - Inserir registro de exemplo com todos os campos obrigatórios
   - Verificar que campos GENERATED são calculados
   - Validar que cálculos estão corretos (comparar com cálculo manual)

3. **Teste de Imutabilidade:**
   - Tentar UPDATE → deve retornar 0 rows affected (bloqueado por rule)
   - Tentar DELETE → deve retornar 0 rows affected (bloqueado por rule)

4. **Teste de Constraints:**
   - Tentar inserir unidades_boas > unidades_produzidas → deve falhar
   - Tentar inserir duplicata (mesma linha+data+turno+hora) → deve falhar
   - Tentar inserir valores negativos → deve falhar

5. **Teste de Performance:**
   - Inserir 1000 registros de teste
   - Validar que queries com índices são rápidas (< 100ms)

**Example test data:**
```sql
INSERT INTO tboee (
  linhaproducao_id, produto_id, turno_id, departamento_id,
  data_referencia, hora_inicio, hora_fim,
  velocidade_nominal, meta_oee,
  tempo_calendario_minutos,
  tempo_paradas_estrategicas_minutos,
  tempo_paradas_planejadas_minutos,
  tempo_paradas_nao_planejadas_minutos,
  tempo_pequenas_paradas_minutos,
  tempo_retrabalho_minutos,
  unidades_produzidas, unidades_boas, unidades_refugadas,
  calculo_tipo, calculado_por
) VALUES (
  1, 100, 1, 1,
  '2025-11-16', '06:00', '14:00',
  5000.00, 85.00,
  480,  -- 8 horas
  0,    -- Sem paradas estratégicas
  30,   -- 30 min setup
  45,   -- 45 min quebra
  20,   -- 20 min pequenas paradas
  15,   -- 15 min retrabalho
  32000, 31500, 500,
  'MANUAL', 1
);

-- Validar cálculo:
SELECT
  disponibilidade,  -- Esperado: 84.38%
  performance,      -- Esperado: 95.06%
  qualidade,        -- Esperado: 94.81%
  oee,              -- Esperado: 76.02%
  atingiu_meta      -- Esperado: FALSE (76.02% < 85%)
FROM tboee
WHERE oee_id = (SELECT MAX(oee_id) FROM tboee);
```

## Change Log

| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-11-16 | 1.0     | Story criada                         | Sarah  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
