# Story 001.002: Migration - View vw_supervisao_turnos

## Status
Draft

## Story

**As a** desenvolvedor do sistema OEE,
**I want** criar a view `vw_supervisao_turnos` que consolida dados de lotes e apontamentos,
**so that** a interface de supervisão possa exibir status de turnos de forma eficiente sem múltiplos JOINs complexos.

## Acceptance Criteria

1. View `vw_supervisao_turnos` criada conforme especificação em `database/migrations/10-vw-supervisao-turnos.sql`
2. View retorna dados de identificação do turno: lote_id, numero_lote, linha_nome, departamento_nome, produto_nome, turno_nome, turno_codigo
3. View retorna datas e horários: data_producao, hora_inicio, hora_fim
4. View retorna status: lote_status, turno_status (derivado do lote_status), tem_oee_calculado (boolean)
5. View agrega resumo de paradas: total_paradas (count), total_minutos_paradas (sum), paradas_em_andamento (count com hora_fim IS NULL)
6. View agrega resumo de produção: total_unidades_produzidas (sum), total_apontamentos_producao (count), apontamentos_clp (count), apontamentos_manuais (count)
7. View agrega resumo de qualidade: total_refugo (sum), total_minutos_retrabalho (sum), total_apontamentos_qualidade (count)
8. View busca velocidade_nominal vigente para preview de OEE
9. View busca meta_oee_vigente para preview de OEE
10. View retorna dados de auditoria: conferido_por_supervisor, conferido_em, supervisor_nome, lote_criado_em, lote_atualizado_em
11. View filtra apenas lotes não deletados (deletado = 'N')
12. View executa sem erros e retorna dados corretos
13. Query de SELECT * FROM vw_supervisao_turnos WHERE data_producao = CURRENT_DATE executa em < 500ms
14. Comentário (COMMENT ON VIEW) adicionado explicando propósito

## Tasks / Subtasks

- [ ] Preparar ambiente e validar pre-requisitos (AC: 12)
  - [ ] Verificar que tabelas necessárias existem: tblote, tblinhaproducao, tbdepartamento, tbproduto, tbturno, tbusuario, tbfuncionario
  - [ ] Verificar que tabelas transacionais existem: tbapontamentoparada, tbapontamentoproducao, tbapontamentoqualidade
  - [ ] Verificar que tbvelocidadenominal e tbmetaoee existem (podem estar vazias)

- [ ] Criar estrutura base da view (AC: 1, 2, 3, 4)
  - [ ] CREATE OR REPLACE VIEW vw_supervisao_turnos AS
  - [ ] SELECT campos de identificação do lote (lote_id, numero_lote)
  - [ ] JOIN com tblinhaproducao para obter linhaproducao_id e linha_nome
  - [ ] JOIN com tbdepartamento para obter departamento_id e departamento_nome
  - [ ] JOIN com tbproduto para obter produto_id e produto_nome
  - [ ] LEFT JOIN com tbturno para obter turno_id, turno_nome, turno_codigo
  - [ ] SELECT datas e horários: data_producao, hora_inicio, hora_fim
  - [ ] SELECT lote_status
  - [ ] Calcular turno_status via CASE (EM_ANDAMENTO → ABERTO, CONCLUIDO → FECHADO)

- [ ] Adicionar campo tem_oee_calculado (AC: 4)
  - [ ] Usar EXISTS com subquery: SELECT 1 FROM tboee WHERE lote_id = l.lote_id AND status = 'ATIVO'
  - [ ] Retornar BOOLEAN

- [ ] Implementar agregação de paradas (AC: 5)
  - [ ] Subquery para total_paradas: COUNT(*) FROM tbapontamentoparada WHERE lote_id = l.lote_id
  - [ ] Subquery para total_minutos_paradas: SUM(EXTRACT(EPOCH FROM (COALESCE(hora_fim, CURRENT_TIME) - hora_inicio)) / 60)
  - [ ] Usar COALESCE para paradas ainda em andamento (hora_fim NULL)
  - [ ] Subquery para paradas_em_andamento: COUNT(*) WHERE hora_fim IS NULL

- [ ] Implementar agregação de produção (AC: 6)
  - [ ] Subquery para total_unidades_produzidas: COALESCE(SUM(unidades_produzidas), 0)
  - [ ] Subquery para total_apontamentos_producao: COUNT(*)
  - [ ] Subquery para apontamentos_clp: COUNT(*) WHERE fonte_dados = 'CLP_AUTOMATICO'
  - [ ] Subquery para apontamentos_manuais: COUNT(*) WHERE fonte_dados = 'MANUAL'

- [ ] Implementar agregação de qualidade (AC: 7)
  - [ ] Subquery para total_refugo: COALESCE(SUM(unidades_refugadas), 0) WHERE tipo_perda = 'REFUGO'
  - [ ] Subquery para total_minutos_retrabalho: COALESCE(SUM(tempo_retrabalho_minutos), 0) WHERE tipo_perda = 'RETRABALHO'
  - [ ] Subquery para total_apontamentos_qualidade: COUNT(*)

- [ ] Buscar velocidade_nominal vigente (AC: 8)
  - [ ] Subquery: SELECT velocidade FROM tbvelocidadenominal WHERE linhaproducao_id = lp.linhaproducao_id AND produto_id = p.produto_id AND deletado = 'N' LIMIT 1
  - [ ] Retornar NULL se não houver velocidade cadastrada

- [ ] Buscar meta_oee_vigente (AC: 9)
  - [ ] Subquery: SELECT meta_oee FROM tbmetaoee WHERE linha_id = lp.linhaproducao_id AND data_producao BETWEEN data_inicio_vigencia AND COALESCE(data_fim_vigencia, '9999-12-31') AND deletado = 'N' ORDER BY data_inicio_vigencia DESC LIMIT 1
  - [ ] Retornar NULL se não houver meta cadastrada

- [ ] Adicionar dados de auditoria (AC: 10)
  - [ ] Campo conferido_por_supervisor de tblote
  - [ ] Campo conferido_em de tblote
  - [ ] Subquery para supervisor_nome: SELECT u.nome FROM tbusuario u JOIN tbfuncionario f ON u.funcionario_id = f.funcionario_id WHERE u.usuario_id = l.conferido_por_supervisor
  - [ ] Campos lote_criado_em (created_at), lote_atualizado_em (updated_at)

- [ ] Adicionar filtro e ordenação (AC: 11)
  - [ ] WHERE l.deletado = 'N'
  - [ ] Não adicionar ORDER BY na view (deixar para queries)

- [ ] Adicionar comentário de documentação (AC: 14)
  - [ ] COMMENT ON VIEW vw_supervisao_turnos IS 'View consolidada para página de supervisão de turnos. Agrega apontamentos de paradas, produção e qualidade.'

- [ ] Executar migration e validar (AC: 12, 13)
  - [ ] Executar script 10-vw-supervisao-turnos.sql no Supabase
  - [ ] Verificar que view foi criada sem erros
  - [ ] Testar SELECT * FROM vw_supervisao_turnos LIMIT 10
  - [ ] Se houver lotes de exemplo, validar que dados estão corretos
  - [ ] Testar query com filtro de data: WHERE data_producao = CURRENT_DATE
  - [ ] Medir tempo de execução (deve ser < 500ms mesmo sem dados)
  - [ ] Validar que subqueries retornam 0/NULL quando não há dados (não erro)

## Dev Notes

### Relevant Source Tree
```
database/migrations/
├── 02-tables.sql                    # Tabelas base referenciadas
├── 09-tboee-snapshot.sql            # tboee (para EXISTS check)
└── 10-vw-supervisao-turnos.sql      # ⭐ ESTE ARQUIVO (a ser criado nesta story)
```

### Database Structure References

**Tabelas Principais:**
- `tblote`: Lotes de produção (PK: lote_id, status, data_producao, hora_inicio, hora_fim, numero_lote, conferido_por_supervisor, conferido_em)
- `tblinhaproducao`: Linhas (PK: linhaproducao_id, nome: linhaproducao, FK: departamento_id)
- `tbdepartamento`: Departamentos (PK: departamento_id, nome: departamento)
- `tbproduto`: Produtos (PK: produto_id, nome: descricao)
- `tbturno`: Turnos (PK: turno_id, codigo, nome, hora_inicio, hora_fim, duracao_horas)

**Tabelas Transacionais:**
- `tbapontamentoparada`: Paradas (FK: lote_id, campos: hora_inicio, hora_fim, duracao_minutos)
- `tbapontamentoproducao`: Produção (FK: lote_id, campos: unidades_produzidas, fonte_dados)
- `tbapontamentoqualidade`: Qualidade (FK: lote_id, campos: tipo_perda, unidades_refugadas, tempo_retrabalho_minutos)

**Tabelas de Parâmetros:**
- `tbvelocidadenominal`: Velocidades (FK: linhaproducao_id, produto_id, campo: velocidade)
- `tbmetaoee`: Metas (FK: linha_id, campos: meta_oee, data_inicio_vigencia, data_fim_vigencia)

### Performance Considerations

**Uso de Subqueries vs JOINs:**
- View usa subqueries correlacionadas ao invés de JOINs para agregações
- Motivo: Evita explosão de linhas (1 linha por lote, não 1 linha por apontamento)
- PostgreSQL otimiza subqueries correlacionadas eficientemente

**Campos Calculados:**
- total_minutos_paradas calcula duração mesmo para paradas em andamento (usa CURRENT_TIME)
- Isso permite preview em tempo real do total de paradas

**NULL Handling:**
- Usar COALESCE(SUM(...), 0) para garantir 0 ao invés de NULL quando não há apontamentos
- Facilita cálculos no frontend

### View Design Principles

1. **One Row Per Lote:** View retorna exatamente 1 linha por lote
2. **Pre-Aggregated:** Todos os totais são pré-calculados na view
3. **Denormalized:** Informações de múltiplas tabelas consolidadas
4. **Filterable:** Frontend pode filtrar por data_producao, linhaproducao_id, departamento_id, turno_status
5. **Fast:** Projetada para queries rápidas mesmo com milhares de lotes

### Example Query Usage

```sql
-- Buscar turnos do dia (uso principal da view)
SELECT *
FROM vw_supervisao_turnos
WHERE data_producao = CURRENT_DATE
ORDER BY linhaproducao_id, turno_codigo;

-- Buscar apenas turnos abertos
SELECT *
FROM vw_supervisao_turnos
WHERE data_producao = CURRENT_DATE
  AND turno_status = 'ABERTO'
ORDER BY paradas_em_andamento DESC;  -- Priorizar com paradas ativas

-- Buscar turnos de uma linha específica
SELECT *
FROM vw_supervisao_turnos
WHERE linhaproducao_id = 1
  AND data_producao BETWEEN '2025-11-01' AND '2025-11-30'
ORDER BY data_producao, turno_codigo;
```

### Important Notes from Previous Work
- Convenção de nomenclatura: `vw_` para views
- Sempre usar COALESCE para evitar NULLs em agregações
- Timezone padrão é 'America/Fortaleza' mas não afeta esta view (apenas dates/times)
- Campo `deletado` é TEXT 'S'/'N' não BOOLEAN

### Testing Standards

**Test file location:**
- Não aplicável (migration SQL, testar manualmente)

**Testing approach:**

1. **Teste de Estrutura:**
   - Executar migration
   - Validar via `\d vw_supervisao_turnos` que view existe
   - Listar colunas e tipos

2. **Teste Sem Dados:**
   - SELECT * FROM vw_supervisao_turnos WHERE 1=0 (deve retornar 0 rows, não erro)
   - Verificar que subqueries não causam erro quando não há dados

3. **Teste Com Dados de Exemplo (se disponíveis):**
   - Inserir 1 lote de exemplo
   - Inserir 2 paradas (1 ativa, 1 finalizada)
   - Inserir 3 apontamentos de produção (2 CLP, 1 manual)
   - Inserir 1 apontamento de qualidade (refugo)
   - SELECT da view e validar:
     - total_paradas = 2
     - paradas_em_andamento = 1
     - total_apontamentos_producao = 3
     - apontamentos_clp = 2
     - apontamentos_manuais = 1
     - total_refugo = valor inserido
   - Fechar turno (UPDATE lote status = CONCLUIDO)
   - SELECT da view e validar turno_status = 'FECHADO'

4. **Teste de Performance:**
   - Criar script que insere 100 lotes
   - Para cada lote, inserir 5 paradas, 10 produções, 2 qualidades
   - Executar: EXPLAIN ANALYZE SELECT * FROM vw_supervisao_turnos WHERE data_producao = CURRENT_DATE
   - Validar que execution time < 500ms

5. **Teste de Queries Comuns:**
   ```sql
   -- Query 1: Turnos de hoje
   SELECT COUNT(*) FROM vw_supervisao_turnos WHERE data_producao = CURRENT_DATE;

   -- Query 2: Turnos abertos
   SELECT COUNT(*) FROM vw_supervisao_turnos WHERE turno_status = 'ABERTO';

   -- Query 3: Turnos com paradas ativas
   SELECT COUNT(*) FROM vw_supervisao_turnos WHERE paradas_em_andamento > 0;
   ```

## Change Log

| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-11-16 | 1.0     | Story criada                         | Sarah  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
