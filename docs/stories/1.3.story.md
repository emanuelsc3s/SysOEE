# Story 1.3: Implementar Autenticação Básica (Email/Senha)

## Status
**Draft**

## Story

**Como** usuário do sistema,
**Eu quero** fazer login com email e senha,
**Para que** eu possa acessar o sistema de forma autenticada e rastreável.

## Acceptance Criteria

1. Tela de Login (`/login`) com formulário: Email (input), Senha (password input), Botão "Entrar"
2. React Hook Form + Zod validando email formato válido e senha mínimo 8 caracteres
3. Função `signIn(email, password)` chamando `supabase.auth.signInWithPassword()`
4. Redirecionamento para `/dashboard` após login bem-sucedido
5. Mensagem de erro exibida se credenciais inválidas (toast ou text vermelho)
6. Estado de loading no botão "Entrar" (spinner + disabled) durante autenticação
7. Sessão JWT salva automaticamente pelo Supabase (localStorage)
8. Protected route `/dashboard` redirecionando para `/login` se não autenticado

## Tasks / Subtasks

- [ ] **Task 1: Instalar Dependencies** (AC: 2)
  - [ ] `npm install react-hook-form zod @hookform/resolvers`
  - [ ] `npm install react-router-dom` (se ainda não instalado)
  - [ ] Verificar que Supabase client já está instalado (Story 1.2)

- [ ] **Task 2: Criar Tela de Login** (AC: 1)
  - [ ] Criar componente `apps/web/src/pages/Login.tsx`
  - [ ] Formulário com campos Email e Senha
  - [ ] Usar Shadcn/ui Input e Button (ou equivalente)
  - [ ] Layout centralizado, mobile-friendly

- [ ] **Task 3: Implementar Validação com Zod** (AC: 2)
  - [ ] Criar schema Zod: email (formato válido), senha (min 8 chars)
  - [ ] Integrar com React Hook Form via resolver
  - [ ] Exibir erros de validação abaixo dos campos

- [ ] **Task 4: Implementar Função de Login** (AC: 3, 4, 7)
  - [ ] Criar `apps/web/src/services/auth.service.ts`
  - [ ] Função `signIn(email, password)` usando `supabase.auth.signInWithPassword()`
  - [ ] Retornar { user, session } ou error
  - [ ] Salvar sessão automaticamente (Supabase faz isso)
  - [ ] Redirecionar para `/dashboard` após sucesso

- [ ] **Task 5: Implementar Loading State** (AC: 6)
  - [ ] useState para `isLoading`
  - [ ] Desabilitar botão durante loading
  - [ ] Mostrar spinner no botão (Shadcn Button com isLoading prop)

- [ ] **Task 6: Implementar Error Handling** (AC: 5)
  - [ ] Capturar erros de `signInWithPassword()`
  - [ ] Exibir mensagem: "Email ou senha incorretos"
  - [ ] Usar toast (Shadcn Toast) ou texto vermelho abaixo do formulário
  - [ ] Limpar erro ao digitar novamente

- [ ] **Task 7: Criar Protected Route Component** (AC: 8)
  - [ ] Criar `apps/web/src/components/ProtectedRoute.tsx`
  - [ ] Verificar `supabase.auth.getSession()`
  - [ ] Se não autenticado: redirecionar para `/login`
  - [ ] Se autenticado: renderizar children

- [ ] **Task 8: Configurar Rotas**
  - [ ] Criar React Router (se ainda não existe)
  - [ ] Rota `/login` → Login page
  - [ ] Rota `/dashboard` → Protected (ProtectedRoute wrapper)
  - [ ] Rota raiz `/` → redirecionar para `/dashboard`

- [ ] **Task 9: Criar Usuário de Teste no Supabase**
  - [ ] Acessar Supabase Dashboard → Authentication → Users
  - [ ] Criar usuário: teste@farmace.io / senha: Teste123!
  - [ ] Ou usar SQL: `INSERT INTO auth.users ...`

- [ ] **Task 10: Testar Fluxo Completo**
  - [ ] Acessar http://localhost:5173 → deve redirecionar para /login
  - [ ] Tentar login com credenciais erradas → deve exibir erro
  - [ ] Fazer login com teste@farmace.io → deve redirecionar para /dashboard
  - [ ] Refresh da página → deve permanecer logado
  - [ ] Verificar localStorage: deve ter chave `sb-xxx-auth-token`

## Dev Notes

### Previous Story Insights
**Story Anterior:** 1.2 (Supabase Cloud)
- Supabase client já configurado em `src/lib/supabase.ts`
- Conexão testada e funcionando
- Agora vamos implementar autenticação usando Supabase Auth

### Authentication Flow

**Login Flow:**
```
User → Login Page → Enter Credentials
    ↓
React Hook Form Validation (Zod)
    ↓
supabase.auth.signInWithPassword()
    ↓
Success: Save session → Redirect /dashboard
    ↓
Error: Display error message
```

**Protected Route Flow:**
```
User → Access /dashboard
    ↓
ProtectedRoute checks session
    ↓
Authenticated: Render Dashboard
    ↓
Not Authenticated: Redirect /login
```

### Code Examples

**Login Page (Login.tsx):**
```typescript
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { signIn } from '@/services/auth.service'
import { useNavigate } from 'react-router-dom'

const loginSchema = z.object({
  email: z.string().email('Email inválido'),
  password: z.string().min(8, 'Senha deve ter no mínimo 8 caracteres')
})

type LoginForm = z.infer<typeof loginSchema>

export function Login() {
  const navigate = useNavigate()
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState('')

  const { register, handleSubmit, formState: { errors } } = useForm<LoginForm>({
    resolver: zodResolver(loginSchema)
  })

  const onSubmit = async (data: LoginForm) => {
    setIsLoading(true)
    setError('')

    const { error } = await signIn(data.email, data.password)

    if (error) {
      setError('Email ou senha incorretos')
      setIsLoading(false)
      return
    }

    navigate('/dashboard')
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <input {...register('email')} type="email" placeholder="Email" />
      {errors.email && <span>{errors.email.message}</span>}

      <input {...register('password')} type="password" placeholder="Senha" />
      {errors.password && <span>{errors.password.message}</span>}

      {error && <div className="error">{error}</div>}

      <button type="submit" disabled={isLoading}>
        {isLoading ? 'Entrando...' : 'Entrar'}
      </button>
    </form>
  )
}
```

**Auth Service (auth.service.ts):**
```typescript
import { supabase } from '@/lib/supabase'

export async function signIn(email: string, password: string) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  })

  return { user: data?.user, session: data?.session, error }
}

export async function signOut() {
  await supabase.auth.signOut()
}

export async function getSession() {
  const { data: { session } } = await supabase.auth.getSession()
  return session
}
```

**Protected Route (ProtectedRoute.tsx):**
```typescript
import { useEffect, useState } from 'react'
import { Navigate } from 'react-router-dom'
import { getSession } from '@/services/auth.service'

export function ProtectedRoute({ children }: { children: React.ReactNode }) {
  const [isAuthenticated, setIsAuthenticated] = useState<boolean | null>(null)

  useEffect(() => {
    getSession().then(session => {
      setIsAuthenticated(!!session)
    })
  }, [])

  if (isAuthenticated === null) {
    return <div>Carregando...</div>
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}
```

### Supabase Auth

**Como funciona:**
- Supabase usa JWT (JSON Web Tokens)
- Token armazenado em localStorage automaticamente
- Token expira em 1h (refresh automático se `autoRefreshToken: true`)
- RLS (Row Level Security) usa `auth.uid()` para identificar usuário

**Criar Usuário de Teste (SQL):**
```sql
-- Via Supabase SQL Editor
INSERT INTO auth.users (
  instance_id,
  id,
  email,
  encrypted_password,
  email_confirmed_at,
  created_at,
  updated_at
) VALUES (
  '00000000-0000-0000-0000-000000000000',
  gen_random_uuid(),
  'teste@farmace.io',
  crypt('Teste123!', gen_salt('bf')),
  now(),
  now(),
  now()
);
```

**Ou via Dashboard:**
Dashboard → Authentication → Add User → Email + Password

### UI/UX Considerations

**[Fonte: docs/prd/epic-1-foundation-infrastructure.md]**

- Mobile-first (telas 1366×768 comuns)
- Feedback visual claro (loading, erros)
- Validação em tempo real (não apenas no submit)
- Mensagens de erro em português

### Security Notes

**Compliance ALCOA+:**
- **Atribuível:** JWT contém user_id (rastreável)
- **Contemporâneo:** Timestamps automáticos no login
- Será expandido no Epic 2 com audit trail completo

**Boas Práticas:**
- Não logar senhas no console
- Não expor SERVICE_ROLE_KEY (apenas ANON_KEY)
- Usar HTTPS em produção (Cloudflare fornece)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-26 | 1.0 | História criada | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used
_A ser preenchido pelo Dev Agent_

### Debug Log References
_A ser preenchido pelo Dev Agent_

### Completion Notes
_A ser preenchido pelo Dev Agent_

### File List
_A ser preenchido pelo Dev Agent_

---

## QA Results
_A ser preenchido pelo QA Agent_
