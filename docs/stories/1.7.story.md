# Story 1.7: Criar Health-Check Route e Validar Deploy

## Status
**Draft**

## Story

**Como** desenvolvedor,
**Eu quero** rota de health-check funcionando no ambiente de produção,
**Para que** valide que deploy automático GitHub → Cloudflare está correto.

## Acceptance Criteria

1. Rota `/health` (não autenticada) retornando JSON: `{ status: "ok", version: "1.0.0", timestamp: "ISO8601", database: "connected", environment: "production" }`
2. Health-check testando conexão Supabase: `SELECT 1` (retorna `database: "error"` se falhar)
3. Se Supabase falhar: retorna `{ "database": "error", "status": "degraded" }`
4. **Teste Local:** `http://localhost:5173/health` retorna 200 OK
5. **Teste Produção:** `https://sysoee.farmace.io/health` retorna 200 OK
6. Dashboard canary em `/dashboard` (rota autenticada) exibindo: "Sistema OEE - Protótipo MVP", Logo Farmace/SicFar, Card "Bem-vindo, {nome_usuario}"
7. Layout base com header: Logo, título "SysOEE", badge de status conexão, nome do usuário, botão "Sair"
8. Footer com versão do sistema e link para documentação
9. Navegação funcional (ainda sem páginas completas, mas estrutura de rotas pronta)
10. **Validar Deploy Automático:** Fazer commit no GitHub → Aguardar deploy Cloudflare (~2-3min) → Verificar mudança em `https://sysoee.farmace.io`
11. Testes manuais: acessar `/health` retorna 200 OK, acessar `/dashboard` sem login redireciona para `/login`

## Tasks / Subtasks

- [ ] **Task 1: Criar Health-Check Route** (AC: 1, 2, 3)
  - [ ] Criar arquivo `apps/web/src/pages/Health.tsx`
  - [ ] Rota não autenticada (sem ProtectedRoute)
  - [ ] Função async para testar conexão Supabase
  - [ ] Retornar JSON com status

- [ ] **Task 2: Implementar Teste de Conexão Supabase** (AC: 2, 3)
  - [ ] Try/catch ao executar `SELECT 1`
  - [ ] Se sucesso: `database: "connected"`
  - [ ] Se erro: `database: "error"`, `status: "degraded"`

- [ ] **Task 3: Adicionar Metadata** (AC: 1)
  - [ ] Version: ler de package.json (import version)
  - [ ] Timestamp: `new Date().toISOString()`
  - [ ] Environment: `import.meta.env.MODE` (development/production)

- [ ] **Task 4: Configurar Rota /health**
  - [ ] React Router: adicionar rota `/health`
  - [ ] Não usar ProtectedRoute (pública)
  - [ ] Renderizar JSON (não componente React)

- [ ] **Task 5: Criar Dashboard Canary** (AC: 6)
  - [ ] Criar arquivo `apps/web/src/pages/Dashboard.tsx`
  - [ ] Layout simples: header + content + footer
  - [ ] Texto: "Sistema OEE - Protótipo MVP"
  - [ ] Card: "Bem-vindo, {user.email}"

- [ ] **Task 6: Criar Layout Base** (AC: 7, 8)
  - [ ] Componente `<AppLayout>`
  - [ ] Header: Logo, título, ConnectionBadge, SessionTimer, UserMenu
  - [ ] Footer: versão do sistema, links
  - [ ] Responsive (mobile-first)

- [ ] **Task 7: Adicionar Logo Farmace/SicFar** (AC: 6)
  - [ ] Adicionar imagem em `apps/web/public/logo.png`
  - [ ] Exibir no header: `<img src="/logo.png" alt="SicFar" />`

- [ ] **Task 8: Criar UserMenu** (AC: 7)
  - [ ] Dropdown com nome do usuário
  - [ ] Opções: "Meu Perfil", "Sair"
  - [ ] Botão "Sair" → supabase.auth.signOut() → redirect /login

- [ ] **Task 9: Configurar Navegação** (AC: 9)
  - [ ] React Router com rotas:
    - `/` → redirect `/dashboard`
    - `/login` → Login page
    - `/dashboard` → Dashboard (protected)
    - `/health` → Health check (public)
  - [ ] Link no menu (ainda sem páginas)

- [ ] **Task 10: Testar Local** (AC: 4)
  - [ ] `npm run dev`
  - [ ] Acessar http://localhost:5173/health
  - [ ] Verificar JSON retornado
  - [ ] Status 200 OK

- [ ] **Task 11: Fazer Deploy e Testar Produção** (AC: 5, 10)
  - [ ] `git add . && git commit -m "feat: health-check route"`
  - [ ] `git push origin main`
  - [ ] Aguardar deploy Cloudflare (~2-3min)
  - [ ] Acessar https://sysoee.farmace.io/health
  - [ ] Verificar JSON retornado

- [ ] **Task 12: Testar Redirect de Autenticação** (AC: 11)
  - [ ] Acessar https://sysoee.farmace.io/dashboard (sem login)
  - [ ] Deve redirecionar para /login
  - [ ] Fazer login → deve ir para /dashboard

## Dev Notes

### Previous Story Insights
**Story Anterior:** 1.6 (Keep-Alive)
- KeepAlive já configurado
- SessionTimer já criado
- Agora vamos criar dashboard canary e validar deploy

### Health-Check Implementation

**Why Health-Check?**
- Validar que deploy funcionou
- Monitoramento (uptime, database)
- Debugging rápido (qual versão está em produção?)

**Response Format:**
```json
{
  "status": "ok",
  "version": "1.0.0",
  "timestamp": "2025-10-26T14:30:00.000Z",
  "database": "connected",
  "environment": "production"
}
```

**Code Example:**
```typescript
// apps/web/src/pages/Health.tsx
import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'
import packageJson from '../../package.json'

interface HealthStatus {
  status: 'ok' | 'degraded'
  version: string
  timestamp: string
  database: 'connected' | 'error'
  environment: string
}

export function Health() {
  const [health, setHealth] = useState<HealthStatus | null>(null)

  useEffect(() => {
    checkHealth()
  }, [])

  async function checkHealth() {
    let databaseStatus: 'connected' | 'error' = 'connected'

    try {
      const { error } = await supabase.from('setores').select('count').limit(1)
      if (error) throw error
    } catch (error) {
      console.error('Health check failed:', error)
      databaseStatus = 'error'
    }

    const status: HealthStatus = {
      status: databaseStatus === 'connected' ? 'ok' : 'degraded',
      version: packageJson.version,
      timestamp: new Date().toISOString(),
      database: databaseStatus,
      environment: import.meta.env.MODE
    }

    setHealth(status)
  }

  if (!health) {
    return <div>Checking...</div>
  }

  return (
    <pre style={{ padding: '20px', fontFamily: 'monospace' }}>
      {JSON.stringify(health, null, 2)}
    </pre>
  )
}
```

### Dashboard Canary

```typescript
// apps/web/src/pages/Dashboard.tsx
import { AppLayout } from '@/components/AppLayout'
import { supabase } from '@/lib/supabase'
import { useEffect, useState } from 'react'

export function Dashboard() {
  const [user, setUser] = useState<any>(null)

  useEffect(() => {
    supabase.auth.getSession().then(({ data }) => {
      setUser(data.session?.user)
    })
  }, [])

  return (
    <AppLayout>
      <div className="p-8">
        <h1 className="text-3xl font-bold mb-4">
          Sistema OEE - Protótipo MVP
        </h1>

        {user && (
          <div className="bg-white shadow rounded-lg p-6">
            <h2 className="text-xl mb-2">Bem-vindo, {user.email}</h2>
            <p className="text-gray-600">
              Sessão ativa. Sistema operacional.
            </p>
          </div>
        )}
      </div>
    </AppLayout>
  )
}
```

### App Layout Component

```typescript
// apps/web/src/components/AppLayout.tsx
import { ConnectionBadge } from './ConnectionBadge'
import { SessionTimer } from './SessionTimer'
import { UserMenu } from './UserMenu'

export function AppLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen flex flex-col">
      {/* Header */}
      <header className="bg-blue-600 text-white p-4">
        <div className="container mx-auto flex items-center justify-between">
          <div className="flex items-center gap-4">
            <img src="/logo.png" alt="SicFar" className="h-10" />
            <h1 className="text-2xl font-bold">SysOEE</h1>
          </div>

          <div className="flex items-center gap-4">
            <ConnectionBadge />
            <SessionTimer />
            <UserMenu />
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1">
        {children}
      </main>

      {/* Footer */}
      <footer className="bg-gray-100 p-4 text-center text-sm text-gray-600">
        <p>SysOEE v{import.meta.env.VITE_APP_VERSION || '1.0.0'}</p>
        <p>
          <a href="/docs" className="text-blue-600 hover:underline">
            Documentação
          </a>
        </p>
      </footer>
    </div>
  )
}
```

### User Menu Component

```typescript
// apps/web/src/components/UserMenu.tsx
import { supabase } from '@/lib/supabase'
import { useNavigate } from 'react-router-dom'
import { useState, useEffect } from 'react'

export function UserMenu() {
  const navigate = useNavigate()
  const [user, setUser] = useState<any>(null)

  useEffect(() => {
    supabase.auth.getSession().then(({ data }) => {
      setUser(data.session?.user)
    })
  }, [])

  async function handleLogout() {
    await supabase.auth.signOut()
    navigate('/login')
  }

  if (!user) return null

  return (
    <div className="relative">
      <button className="flex items-center gap-2">
        <span>{user.email}</span>
        <svg className="w-4 h-4" /* dropdown icon */ />
      </button>

      {/* Dropdown menu (implementar com Shadcn DropdownMenu) */}
      <div className="absolute right-0 mt-2 w-48 bg-white rounded shadow-lg">
        <a href="/perfil" className="block px-4 py-2 hover:bg-gray-100">
          Meu Perfil
        </a>
        <button
          onClick={handleLogout}
          className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600"
        >
          Sair
        </button>
      </div>
    </div>
  )
}
```

### Router Configuration

```typescript
// apps/web/src/main.tsx ou App.tsx
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom'
import { Health } from './pages/Health'
import { Login } from './pages/Login'
import { Dashboard } from './pages/Dashboard'
import { ProtectedRoute } from './components/ProtectedRoute'

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<Navigate to="/dashboard" replace />} />
        <Route path="/health" element={<Health />} />
        <Route path="/login" element={<Login />} />
        <Route
          path="/dashboard"
          element={
            <ProtectedRoute>
              <Dashboard />
            </ProtectedRoute>
          }
        />
      </Routes>
    </BrowserRouter>
  )
}
```

### Deploy Validation

**GitHub → Cloudflare Flow:**
1. Developer: `git push origin main`
2. GitHub: trigger webhook to Cloudflare
3. Cloudflare: build `npm run build`
4. Cloudflare: deploy to https://sysoee.farmace.io
5. ~2-3 minutos total

**Como Validar:**
```bash
# 1. Fazer mudança pequena
echo "export const VERSION = '1.0.1'" > apps/web/src/version.ts

# 2. Commit e push
git add .
git commit -m "chore: bump version"
git push origin main

# 3. Aguardar 2-3min

# 4. Verificar produção
curl https://sysoee.farmace.io/health
# Deve retornar JSON com version: "1.0.1"
```

### Testing Checklist

**Local (AC#4):**
- [ ] http://localhost:5173/health → 200 OK
- [ ] JSON contém: status, version, timestamp, database, environment
- [ ] database: "connected"

**Produção (AC#5):**
- [ ] https://sysoee.farmace.io/health → 200 OK
- [ ] JSON contém mesmos campos
- [ ] environment: "production"

**Autenticação (AC#11):**
- [ ] https://sysoee.farmace.io → redireciona /login
- [ ] https://sysoee.farmace.io/dashboard (sem login) → redireciona /login
- [ ] Login válido → acessa /dashboard OK

**Deploy Automático (AC#10):**
- [ ] Commit → push
- [ ] Cloudflare build (~2min)
- [ ] Mudança visível em produção

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-26 | 1.0 | História criada | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used
_A ser preenchido pelo Dev Agent_

### Debug Log References
_A ser preenchido pelo Dev Agent_

### Completion Notes
_A ser preenchido pelo Dev Agent_

### File List
_A ser preenchido pelo Dev Agent_

---

## QA Results
_A ser preenchido pelo QA Agent_
