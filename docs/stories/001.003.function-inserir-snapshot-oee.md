# Story 001.003: Function PostgreSQL - inserir_snapshot_oee()

## Status
Draft

## Story

**As a** desenvolvedor do sistema OEE,
**I want** criar a function `inserir_snapshot_oee()` que agrega apontamentos e calcula OEE,
**so that** ao fechar um turno o sistema possa automaticamente calcular e persistir o OEE em tboee.

## Acceptance Criteria

1. Function `inserir_snapshot_oee(p_lote_id UUID)` criada retornando INTEGER (oee_id inserido)
2. Function busca velocidade_nominal vigente atual de tbvelocidadenominal para linha+produto
3. Function busca meta_oee vigente de tbmetaoee para linha na data (ou usa padrão 85%)
4. Function agrega TODAS as paradas do lote via SUM/COUNT de tbapontamentoparada, classificando por tipo_parada (ESTRATEGICA, PLANEJADA, NAO_PLANEJADA) e identificando pequenas paradas (< 10 min)
5. Function agrega TODA a produção do lote via SUM de tbapontamentoproducao.unidades_produzidas
6. Function agrega TODA a qualidade do lote: refugo (SUM de unidades_refugadas) e retrabalho (SUM de tempo_retrabalho_minutos)
7. Function calcula tempo_calendario_minutos a partir de hora_inicio e hora_fim do lote
8. Function insere registro em tboee com todos os campos populados corretamente
9. Function retorna oee_id do registro inserido
10. Function lança exceção com mensagem clara se velocidade_nominal não for encontrada
11. Function executa sem erros quando chamada com lote_id válido
12. Function pode ser chamada via `SELECT inserir_snapshot_oee('uuid-lote')` ou via RPC do Supabase
13. Validação: OEE calculado automaticamente pelos campos GENERATED está correto conforme fórmulas
14. Comentário (COMMENT ON FUNCTION) adicionado explicando propósito e parâmetros

## Tasks / Subtasks

- [ ] Criar assinatura da function (AC: 1, 12)
  - [ ] CREATE OR REPLACE FUNCTION inserir_snapshot_oee(p_lote_id UUID) RETURNS INTEGER
  - [ ] Definir variáveis locais (v_velocidade, v_meta, v_oee_id, etc.)
  - [ ] BEGIN...END block

- [ ] Buscar dados do lote (AC: 7)
  - [ ] SELECT linhaproducao_id, produto_id, turno_id, departamento_id, data_producao, hora_inicio, hora_fim FROM tblote WHERE lote_id = p_lote_id
  - [ ] Validar que lote existe (se não, RAISE EXCEPTION 'Lote não encontrado')
  - [ ] Calcular tempo_calendario_minutos: EXTRACT(EPOCH FROM (hora_fim - hora_inicio)) / 60

- [ ] Buscar velocidade_nominal vigente (AC: 2, 10)
  - [ ] SELECT velocidade INTO v_velocidade FROM tbvelocidadenominal WHERE linhaproducao_id = ... AND produto_id = ... AND deletado = 'N' LIMIT 1
  - [ ] Se NOT FOUND, RAISE EXCEPTION 'Velocidade nominal não cadastrada para linha X produto Y'

- [ ] Buscar meta_oee vigente (AC: 3)
  - [ ] SELECT meta_oee INTO v_meta FROM tbmetaoee WHERE linha_id = ... AND data_producao BETWEEN vigencias AND deletado = 'N' ORDER BY data_inicio_vigencia DESC LIMIT 1
  - [ ] Se NOT FOUND, v_meta := 85.00 (meta padrão)

- [ ] Agregar paradas por tipo (AC: 4)
  - [ ] WITH paradas AS (SELECT SUM(CASE WHEN cp.tipo_parada = 'ESTRATEGICA' ...) FROM tbapontamentoparada ap JOIN tbcodigoparada cp ...)
  - [ ] Calcular: estrategicas, planejadas, nao_planejadas
  - [ ] Calcular pequenas_paradas: SUM(CASE WHEN duracao_minutos < 10 THEN duracao_minutos ELSE 0 END)
  - [ ] Armazenar em variáveis

- [ ] Agregar produção (AC: 5)
  - [ ] SELECT COALESCE(SUM(unidades_produzidas), 0) INTO v_total_produzido FROM tbapontamentoproducao WHERE lote_id = p_lote_id

- [ ] Agregar qualidade (AC: 6)
  - [ ] SELECT COALESCE(SUM(CASE WHEN tipo_perda = 'REFUGO' THEN unidades_refugadas ...)) INTO v_refugo FROM tbapontamentoqualidade WHERE lote_id = p_lote_id
  - [ ] SELECT COALESCE(SUM(CASE WHEN tipo_perda = 'RETRABALHO' THEN tempo_retrabalho_minutos ...)) INTO v_retrabalho
  - [ ] Calcular v_unidades_boas: v_total_produzido - v_refugo

- [ ] Inserir snapshot em tboee (AC: 8, 9)
  - [ ] INSERT INTO tboee (...) VALUES (...) RETURNING oee_id INTO v_oee_id
  - [ ] Preencher todos os campos obrigatórios
  - [ ] calculo_tipo = 'AUTOMATICO'
  - [ ] calculado_por = NULL (sistema)
  - [ ] status = 'ATIVO'

- [ ] Retornar oee_id (AC: 9)
  - [ ] RETURN v_oee_id

- [ ] Adicionar tratamento de erros
  - [ ] EXCEPTION WHEN OTHERS THEN RAISE com mensagem clara

- [ ] Adicionar comentário (AC: 14)
  - [ ] COMMENT ON FUNCTION inserir_snapshot_oee IS 'Agrega apontamentos de um lote e calcula OEE, inserindo snapshot em tboee. Chamada ao fechar turno.'

- [ ] Testar function (AC: 11, 13)
  - [ ] Criar lote de teste com paradas, produção e qualidade
  - [ ] Chamar SELECT inserir_snapshot_oee('uuid-lote-teste')
  - [ ] Verificar que retornou oee_id > 0
  - [ ] SELECT * FROM tboee WHERE oee_id = resultado
  - [ ] Validar que todos os campos foram populados
  - [ ] Validar que cálculos (disponibilidade, performance, qualidade, oee) estão corretos
  - [ ] Calcular manualmente OEE esperado e comparar

## Dev Notes

### Relevant Source Tree
```
database/migrations/
├── 09-tboee-snapshot.sql         # Tabela destino
├── 10-vw-supervisao-turnos.sql   # View (não usado pela function)
└── 11-function-inserir-oee.sql   # ⭐ ESTE ARQUIVO (a ser criado nesta story)
```

### Function Design

**Input:** `p_lote_id UUID`
**Output:** `INTEGER` (oee_id do registro inserido)

**Lógica:**
1. Buscar dados do lote
2. Buscar parâmetros (velocidade, meta)
3. Agregar apontamentos (paradas, produção, qualidade)
4. Inserir em tboee
5. Retornar oee_id

**Importante:** Campos de OEE (disponibilidade, performance, qualidade, oee) são GENERATED, então NÃO incluir no INSERT - serão calculados automaticamente!

### Aggregation Queries Structure

```sql
-- Paradas
WITH paradas AS (
  SELECT
    COALESCE(SUM(CASE WHEN cp.tipo_parada = 'ESTRATEGICA' THEN ap.duracao_minutos ELSE 0 END), 0) AS estrategicas,
    COALESCE(SUM(CASE WHEN cp.tipo_parada = 'PLANEJADA' THEN ap.duracao_minutos ELSE 0 END), 0) AS planejadas,
    COALESCE(SUM(CASE WHEN cp.tipo_parada = 'NAO_PLANEJADA' THEN ap.duracao_minutos ELSE 0 END), 0) AS nao_planejadas,
    COALESCE(SUM(CASE WHEN ap.duracao_minutos < 10 THEN ap.duracao_minutos ELSE 0 END), 0) AS pequenas
  FROM tbapontamentoparada ap
  JOIN tbcodigoparada cp ON ap.codigo_parada_id = cp.id
  WHERE ap.lote_id = p_lote_id
    AND ap.deletado = 'N'
)
```

### Error Messages
- "Lote %s não encontrado" (p_lote_id)
- "Velocidade nominal não cadastrada para linha %s produto %s" (linhaproducao_id, produto_id)
- "Lote %s não possui hora_fim definida" (validar antes de calcular tempo_calendario)

### Testing with Real Data

Se houver o registro de velocidade mencionado pelo usuário:
1. Usar esse produto_id e linhaproducao_id
2. Criar lote de teste com esses IDs
3. Criar apontamentos de exemplo
4. Chamar function e validar resultado

### Testing Standards

**Test Scenario 1: Lote Completo**
```sql
-- Setup
INSERT INTO tblote (...) VALUES (...) RETURNING lote_id INTO v_test_lote_id;
INSERT INTO tbapontamentoparada (...) VALUES (v_test_lote_id, ...); -- 2 paradas
INSERT INTO tbapontamentoproducao (...) VALUES (v_test_lote_id, ...); -- 32000 unidades
INSERT INTO tbapontamentoqualidade (...) VALUES (v_test_lote_id, ...); -- 500 refugo

-- Execute
SELECT inserir_snapshot_oee(v_test_lote_id) INTO v_oee_id;

-- Validate
SELECT oee FROM tboee WHERE oee_id = v_oee_id;
-- Comparar com cálculo manual
```

**Test Scenario 2: Erro - Sem Velocidade**
```sql
-- Chamar function com produto sem velocidade cadastrada
-- Deve retornar erro com mensagem clara
```

**Test Scenario 3: Lote Sem Apontamentos**
```sql
-- Lote sem paradas, sem produção
-- Deve inserir OEE = 0%
```

## Change Log

| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-11-16 | 1.0     | Story criada                         | Sarah  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
