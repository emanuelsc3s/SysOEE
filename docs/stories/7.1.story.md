# Story 7.1: Criar Tela de Gerenciamento de Velocidades Nominais

## Status
**Draft**

## Story

**Como** engenheiro de processos,
**Eu quero** cadastrar e atualizar velocidades nominais por SKU em cada linha,
**Para que** cálculos de Performance reflitam capacidade real de cada produto.

## Acceptance Criteria

1. Rota `/admin/velocidades-nominais` (protegida, role: admin, engenharia)
2. Tabela listando: Linha, SKU (código + descrição), Velocidade Nominal (Und/h), Última Atualização, Ações (Editar, Desativar)
3. Botão "Nova Velocidade Nominal" → abre modal com campos: Linha (select), SKU Código (input), SKU Descrição (input), Velocidade Nominal (numeric input)
4. INSERT em tabela `velocidades_nominais`: linha_id, sku_codigo, sku_descricao, velocidade_nominal_undh, created_by, created_at
5. Editar velocidade: abre modal similar, campos pré-preenchidos, UPDATE em vez de INSERT
6. Audit trail: trigger registra alterações (campo velocidade_nominal old → new)
7. Validação: velocidade nominal > 0, SKU único por linha
8. Filtros: buscar por linha ou SKU (debounced input)
9. Histórico: botão "Ver Histórico" → modal listando alterações anteriores via `audit_log`

## Tasks / Subtasks

- [ ] **Task 1: Criar Migration para Tabela velocidades_nominais** (AC: 4)
  - [ ] Criar migration `20250105000000_velocidades_nominais.sql`
  - [ ] CREATE TABLE velocidades_nominais
  - [ ] Colunas: id, linha_id (FK), sku_codigo, sku_descricao, velocidade_nominal_undh, is_ativo, created_by, created_at, updated_at
  - [ ] UNIQUE constraint (linha_id, sku_codigo)
  - [ ] CHECK constraint velocidade_nominal_undh > 0

- [ ] **Task 2: Criar Audit Trigger** (AC: 6)
  - [ ] Reutilizar função audit_trigger_func() (Epic 2)
  - [ ] CREATE TRIGGER em velocidades_nominais
  - [ ] Capturar campo velocidade_nominal_undh changes

- [ ] **Task 3: Criar Rota Admin** (AC: 1)
  - [ ] Criar `apps/web/src/pages/admin/VelocidadesNominais.tsx`
  - [ ] Rota `/admin/velocidades-nominais` no React Router
  - [ ] ProtectedRoute com role check (admin ou engenharia)

- [ ] **Task 4: Criar Tabela de Listagem** (AC: 2)
  - [ ] Query Supabase: JOIN velocidades_nominais + linhas
  - [ ] TanStack Table (ou similar) com colunas: Linha, SKU, Velocidade, Última Atualização, Ações
  - [ ] Ordenação: nome da linha (asc)

- [ ] **Task 5: Implementar Filtros** (AC: 8)
  - [ ] Input de busca: filtrar por linha OU SKU
  - [ ] Debounce 300ms (useDebounce hook)
  - [ ] Query SQL com WHERE linha.nome ILIKE '%search%' OR sku_codigo ILIKE '%search%'

- [ ] **Task 6: Criar Modal de Nova Velocidade** (AC: 3)
  - [ ] Componente `<VelocidadeModal mode="create" />`
  - [ ] Shadcn Dialog
  - [ ] Campos: Linha (Select), SKU Código, SKU Descrição, Velocidade (numeric)
  - [ ] Validação Zod: velocidade > 0, SKU único

- [ ] **Task 7: Implementar CREATE** (AC: 4)
  - [ ] Form submit → INSERT Supabase
  - [ ] Incluir created_by (auth.uid())
  - [ ] Toast sucesso: "Velocidade cadastrada"
  - [ ] Fechar modal e atualizar lista

- [ ] **Task 8: Implementar EDIT** (AC: 5)
  - [ ] Botão "Editar" na tabela → abre modal pré-preenchido
  - [ ] Componente `<VelocidadeModal mode="edit" data={selected} />`
  - [ ] Form submit → UPDATE Supabase
  - [ ] Toast sucesso: "Velocidade atualizada"

- [ ] **Task 9: Implementar Desativar** (AC: 2)
  - [ ] Botão "Desativar" → soft-delete (is_ativo = false)
  - [ ] Confirmação antes: "Desativar velocidade do SKU X?"
  - [ ] UPDATE SET is_ativo = false

- [ ] **Task 10: Criar Modal de Histórico** (AC: 9)
  - [ ] Botão "Ver Histórico" na tabela
  - [ ] Query audit_log WHERE table_name = 'velocidades_nominais' AND record_id = ?
  - [ ] Exibir: Data/Hora, Usuário, Campo Alterado, Valor Anterior, Valor Novo
  - [ ] Ordenação: mais recente primeiro

- [ ] **Task 11: Adicionar RLS Policies**
  - [ ] Policy SELECT: admin e engenharia
  - [ ] Policy INSERT/UPDATE: apenas admin e engenharia
  - [ ] Policy DELETE: bloqueado (apenas soft-delete)

- [ ] **Task 12: Testar CRUD Completo**
  - [ ] Criar velocidade → deve aparecer na lista
  - [ ] Editar velocidade → deve atualizar
  - [ ] Desativar velocidade → deve sumir da lista (filtro is_ativo = true)
  - [ ] Ver histórico → deve mostrar alterações
  - [ ] Tentar criar SKU duplicado → deve falhar com erro claro

## Dev Notes

### Previous Story Insights
**Story Anterior:** Epic 1 completo
- Schema base criado
- Audit trail será criado no Epic 2
- Esta story vem ANTES do Epic 2 na sequência revisada

**Nota:** Mover para APÓS Epic 1, ANTES do Epic 3 (operador precisa de velocidades para cálculos)

### Why Velocidades Nominais?

**[Fonte: docs/project/05-Metodologia-Calculo.md]**

Cálculo de Performance depende de velocidade nominal:
```
Performance (%) = (Tempo Operacional Líquido / Tempo de Operação) × 100

Onde:
Tempo Operacional Líquido = Unidades Produzidas / Velocidade Nominal
```

**Problema:**
- Cada SKU tem velocidade diferente na mesma linha
- Linha A: Soro 500ml = 10.000 Und/h, Soro 1000ml = 8.000 Und/h
- Não podemos usar velocidade fixa da máquina

**Solução:**
- Cadastrar velocidade nominal por SKU por linha
- Usar no cálculo de OEE (Epic 4)

### Database Schema

```sql
-- Migration: Velocidades Nominais
CREATE TABLE velocidades_nominais (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  linha_id UUID NOT NULL REFERENCES linhas(id) ON DELETE CASCADE,
  sku_codigo TEXT NOT NULL,
  sku_descricao TEXT NOT NULL,
  velocidade_nominal_undh NUMERIC NOT NULL CHECK (velocidade_nominal_undh > 0),
  is_ativo BOOLEAN DEFAULT TRUE,
  created_by UUID NOT NULL REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(linha_id, sku_codigo)
);

CREATE INDEX idx_velocidades_linha ON velocidades_nominais(linha_id);
CREATE INDEX idx_velocidades_sku ON velocidades_nominais(sku_codigo);

-- Trigger updated_at
CREATE TRIGGER set_updated_at
BEFORE UPDATE ON velocidades_nominais
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

-- Audit Trigger (Epic 2)
CREATE TRIGGER audit_velocidades_nominais
AFTER INSERT OR UPDATE OR DELETE ON velocidades_nominais
FOR EACH ROW
EXECUTE FUNCTION audit_trigger_func();
```

### UI Component Structure

```typescript
// apps/web/src/pages/admin/VelocidadesNominais.tsx
import { useState } from 'react'
import { useQuery, useMutation } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { VelocidadeModal } from './components/VelocidadeModal'

export function VelocidadesNominais() {
  const [searchTerm, setSearchTerm] = useState('')
  const [isModalOpen, setIsModalOpen] = useState(false)

  const { data: velocidades, refetch } = useQuery({
    queryKey: ['velocidades', searchTerm],
    queryFn: async () => {
      let query = supabase
        .from('velocidades_nominais')
        .select(`
          *,
          linhas(nome, setor_id)
        `)
        .eq('is_ativo', true)

      if (searchTerm) {
        query = query.or(`sku_codigo.ilike.%${searchTerm}%,linhas.nome.ilike.%${searchTerm}%`)
      }

      const { data, error } = await query
      if (error) throw error
      return data
    }
  })

  return (
    <div className="p-8">
      <div className="flex justify-between mb-6">
        <h1 className="text-2xl font-bold">Velocidades Nominais</h1>
        <Button onClick={() => setIsModalOpen(true)}>
          Nova Velocidade Nominal
        </Button>
      </div>

      <Input
        placeholder="Buscar por linha ou SKU..."
        value={searchTerm}
        onChange={(e) => setSearchTerm(e.target.value)}
        className="mb-4"
      />

      {/* Tabela TanStack ou similar */}
      <VelocidadesTable data={velocidades} onEdit={...} onDeactivate={...} />

      <VelocidadeModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        onSuccess={() => {
          refetch()
          setIsModalOpen(false)
        }}
      />
    </div>
  )
}
```

### Modal Component

```typescript
// VelocidadeModal.tsx
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { supabase } from '@/lib/supabase'

const velocidadeSchema = z.object({
  linha_id: z.string().uuid(),
  sku_codigo: z.string().min(1, 'Código obrigatório'),
  sku_descricao: z.string().min(1, 'Descrição obrigatória'),
  velocidade_nominal_undh: z.number().positive('Deve ser > 0')
})

type VelocidadeForm = z.infer<typeof velocidadeSchema>

export function VelocidadeModal({ isOpen, onClose, onSuccess, data }) {
  const { register, handleSubmit, formState: { errors } } = useForm<VelocidadeForm>({
    resolver: zodResolver(velocidadeSchema),
    defaultValues: data || {}
  })

  const onSubmit = async (formData: VelocidadeForm) => {
    const { data: { user } } = await supabase.auth.getUser()

    if (data?.id) {
      // UPDATE
      await supabase
        .from('velocidades_nominais')
        .update(formData)
        .eq('id', data.id)
    } else {
      // INSERT
      await supabase
        .from('velocidades_nominais')
        .insert({
          ...formData,
          created_by: user?.id
        })
    }

    onSuccess()
  }

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent>
        <form onSubmit={handleSubmit(onSubmit)}>
          {/* Campos do formulário */}
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

### RLS Policies

```sql
-- SELECT: admin e engenharia
CREATE POLICY velocidades_select ON velocidades_nominais
FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM user_roles
    WHERE user_id = auth.uid()
    AND role IN ('admin', 'engenharia')
  )
);

-- INSERT/UPDATE: admin e engenharia
CREATE POLICY velocidades_modify ON velocidades_nominais
FOR ALL
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM user_roles
    WHERE user_id = auth.uid()
    AND role IN ('admin', 'engenharia')
  )
);
```

### Integration with OEE Calculation

**Epic 4 usará velocidades nominais:**
```sql
-- Cálculo de Performance (Epic 4)
SELECT
  a.linha_id,
  SUM(a.quantidade_produzida) / AVG(v.velocidade_nominal_undh) as tempo_operacional_liquido
FROM apontamentos a
JOIN velocidades_nominais v ON a.linha_id = v.linha_id AND a.sku_codigo = v.sku_codigo
WHERE a.tipo_evento = 'producao'
GROUP BY a.linha_id
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-26 | 1.0 | História criada | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used
_A ser preenchido pelo Dev Agent_

### Debug Log References
_A ser preenchido pelo Dev Agent_

### Completion Notes
_A ser preenchido pelo Dev Agent_

### File List
_A ser preenchido pelo Dev Agent_

---

## QA Results
_A ser preenchido pelo QA Agent_
