# Story 1.4: Criar Schema Inicial de Banco de Dados

## Status
**Draft**

## Story

**Como** desenvolvedor,
**Eu quero** criar migrations SQL iniciais para tabelas core (users, setores, linhas, apontamentos, assinaturas_eletronicas),
**Para que** estrutura de dados esteja definida antes de implementar features.

## Acceptance Criteria

1. Migration `20250101000000_initial_schema.sql` criada em `supabase/migrations/`
2. Tabela `setores`: id (uuid PK), nome (text NOT NULL), created_at (timestamp)
3. Tabela `linhas`: id (uuid PK), nome (text NOT NULL), setor_id (uuid FK → setores), velocidade_nominal_padrao (numeric), meta_oee (numeric 0-100), created_at
4. Tabela `apontamentos`: id (uuid PK), linha_id (uuid FK), user_id (uuid FK → auth.users), tipo_evento (enum), codigo_parada (text), timestamp_ocorrencia (timestamp NOT NULL), quantidade_afetada (numeric), observacoes (text), status (enum: draft, aguardando_assinatura, assinado), created_at, updated_at
5. Tabela `assinaturas_eletronicas`: id (uuid PK), apontamento_id (uuid FK), supervisor_id (uuid FK → auth.users), hash_sha256 (text NOT NULL), timestamp_assinatura (timestamp NOT NULL), ip_address (inet), device_info (jsonb)
6. Migration aplicada com sucesso via Supabase CLI: `supabase db push`
7. Seed data em `supabase/seed.sql`: 4 setores (SPEP, SPPV, Líquidos, CPHD) e 10 linhas SPEP

## Tasks / Subtasks

- [ ] **Task 1: Instalar Supabase CLI** (AC: 6)
  - [ ] `npm install -g supabase`
  - [ ] Verificar instalação: `supabase --version`
  - [ ] Login: `supabase login`

- [ ] **Task 2: Inicializar Supabase Localmente** (AC: 6)
  - [ ] Na raiz do projeto: `supabase init`
  - [ ] Criar diretório `supabase/migrations/`
  - [ ] Link ao projeto cloud: `supabase link --project-ref <project-id>`

- [ ] **Task 3: Criar Migration Inicial** (AC: 1)
  - [ ] Criar arquivo `supabase/migrations/20250101000000_initial_schema.sql`
  - [ ] Adicionar header comentário: objetivo da migration

- [ ] **Task 4: Criar Tabela setores** (AC: 2)
  - [ ] CREATE TABLE setores
  - [ ] UUID primary key com gen_random_uuid()
  - [ ] Coluna nome NOT NULL
  - [ ] created_at com default now()

- [ ] **Task 5: Criar Tabela linhas** (AC: 3)
  - [ ] CREATE TABLE linhas
  - [ ] Foreign key setor_id → setores(id)
  - [ ] Colunas: velocidade_nominal_padrao, meta_oee (CHECK 0-100)
  - [ ] Índice em setor_id

- [ ] **Task 6: Criar ENUM tipo_evento**
  - [ ] CREATE TYPE tipo_evento_enum AS ENUM ('parada', 'perda_qualidade', 'troca_turno')

- [ ] **Task 7: Criar ENUM status_apontamento**
  - [ ] CREATE TYPE status_apontamento_enum AS ENUM ('draft', 'aguardando_assinatura', 'assinado')

- [ ] **Task 8: Criar Tabela apontamentos** (AC: 4)
  - [ ] CREATE TABLE apontamentos
  - [ ] Foreign keys: linha_id, user_id (auth.users)
  - [ ] Usar ENUMs criados
  - [ ] Índices: linha_id, user_id, timestamp_ocorrencia
  - [ ] Trigger para updated_at

- [ ] **Task 9: Criar Tabela assinaturas_eletronicas** (AC: 5)
  - [ ] CREATE TABLE assinaturas_eletronicas
  - [ ] Foreign keys: apontamento_id, supervisor_id
  - [ ] Constraint UNIQUE em apontamento_id (uma assinatura por apontamento)

- [ ] **Task 10: Criar Tabela books_paradas** (para Story 3.4)
  - [ ] CREATE TABLE books_paradas
  - [ ] Foreign key linha_id
  - [ ] Hierarquia: classe, grande_parada, apontamento, grupo, detalhamento
  - [ ] is_ativo boolean (soft-delete)

- [ ] **Task 11: Criar Seed Data** (AC: 7)
  - [ ] Criar arquivo `supabase/seed.sql`
  - [ ] INSERT 4 setores (SPEP, SPPV, Líquidos, CPHD)
  - [ ] INSERT 10 linhas SPEP (Linha A, B, C... SLE)
  - [ ] Meta OEE padrão: 75%

- [ ] **Task 12: Aplicar Migration** (AC: 6)
  - [ ] `supabase db reset` (local)
  - [ ] `supabase db push` (cloud)
  - [ ] Verificar no dashboard: Tables aparecem

- [ ] **Task 13: Validar Schema**
  - [ ] Conectar via SQL Editor no dashboard
  - [ ] SELECT * FROM setores → deve ter 4 registros
  - [ ] SELECT * FROM linhas → deve ter 10 registros
  - [ ] Testar foreign keys funcionando

## Dev Notes

### Previous Story Insights
**Story Anterior:** 1.3 (Autenticação)
- Auth já configurado, tabela auth.users existe
- Agora vamos criar tabelas de negócio que referenciam auth.users
- Usar auth.uid() para RLS (Epic 2)

### Database Schema

**[Fonte: docs/architecture/database-schema.md]**

**Diagrama Conceitual:**
```
setores (4)
  ↓ 1:N
linhas (37 total, 10 SPEP no MVP)
  ↓ 1:N
apontamentos
  ↓ 1:1
assinaturas_eletronicas

books_paradas → linhas (N:1)
```

### Migration SQL Template

```sql
-- Migration: Initial Schema
-- Created: 2025-01-01
-- Description: Tabelas core para sistema OEE

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Setores (4 setores produtivos)
CREATE TABLE setores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Linhas de Produção (37 total, 10 SPEP no MVP)
CREATE TABLE linhas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome TEXT NOT NULL,
  setor_id UUID NOT NULL REFERENCES setores(id) ON DELETE CASCADE,
  velocidade_nominal_padrao NUMERIC,
  meta_oee NUMERIC CHECK (meta_oee >= 0 AND meta_oee <= 100),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(setor_id, nome)
);

CREATE INDEX idx_linhas_setor ON linhas(setor_id);

-- ENUMs
CREATE TYPE tipo_evento_enum AS ENUM (
  'parada',
  'perda_qualidade',
  'troca_turno'
);

CREATE TYPE status_apontamento_enum AS ENUM (
  'draft',
  'aguardando_assinatura',
  'assinado'
);

-- Apontamentos (registro manual de paradas/perdas)
CREATE TABLE apontamentos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  linha_id UUID NOT NULL REFERENCES linhas(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
  tipo_evento tipo_evento_enum NOT NULL,
  codigo_parada TEXT,
  timestamp_ocorrencia TIMESTAMP WITH TIME ZONE NOT NULL,
  duracao_minutos INTEGER,
  quantidade_afetada NUMERIC,
  observacoes TEXT,
  status status_apontamento_enum DEFAULT 'draft',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_apontamentos_linha ON apontamentos(linha_id);
CREATE INDEX idx_apontamentos_user ON apontamentos(user_id);
CREATE INDEX idx_apontamentos_timestamp ON apontamentos(timestamp_ocorrencia);

-- Trigger para updated_at
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_updated_at
BEFORE UPDATE ON apontamentos
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

-- Assinaturas Eletrônicas (Compliance CFR 21 Part 11)
CREATE TABLE assinaturas_eletronicas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  apontamento_id UUID NOT NULL REFERENCES apontamentos(id) ON DELETE CASCADE UNIQUE,
  supervisor_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
  hash_sha256 TEXT NOT NULL,
  timestamp_assinatura TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  ip_address INET,
  device_info JSONB
);

-- Books de Paradas (códigos por linha)
CREATE TABLE books_paradas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  linha_id UUID NOT NULL REFERENCES linhas(id) ON DELETE CASCADE,
  codigo TEXT NOT NULL,
  classe TEXT,
  grande_parada TEXT,
  apontamento TEXT,
  grupo TEXT,
  detalhamento TEXT,
  is_ativo BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(linha_id, codigo)
);

CREATE INDEX idx_books_linha ON books_paradas(linha_id);
```

### Seed Data

```sql
-- Seed Data: Setores e Linhas SPEP
-- File: supabase/seed.sql

-- Setores
INSERT INTO setores (nome) VALUES
  ('SPEP'),   -- Soluções Parenterais Embalagem Plástica
  ('SPPV'),   -- Soluções Parenterais Pequeno Volume
  ('Líquidos'),
  ('CPHD');   -- Concentrado Polieletrolítico Hemodiálise

-- Linhas SPEP (10 linhas de envase)
INSERT INTO linhas (nome, setor_id, meta_oee) VALUES
  ('Linha A', (SELECT id FROM setores WHERE nome = 'SPEP'), 75),
  ('Linha B', (SELECT id FROM setores WHERE nome = 'SPEP'), 75),
  ('Linha C', (SELECT id FROM setores WHERE nome = 'SPEP'), 75),
  ('Linha D', (SELECT id FROM setores WHERE nome = 'SPEP'), 75),
  ('Linha E', (SELECT id FROM setores WHERE nome = 'SPEP'), 75),
  ('Linha F', (SELECT id FROM setores WHERE nome = 'SPEP'), 75),
  ('Linha G', (SELECT id FROM setores WHERE nome = 'SPEP'), 75),
  ('Linha H', (SELECT id FROM setores WHERE nome = 'SPEP'), 75),
  ('Linha I', (SELECT id FROM setores WHERE nome = 'SPEP'), 75),
  ('SLE', (SELECT id FROM setores WHERE nome = 'SPEP'), 75);
```

### Supabase CLI Commands

```bash
# Inicializar projeto
supabase init

# Link ao projeto cloud
supabase link --project-ref <seu-project-ref>

# Criar nova migration
supabase migration new initial_schema

# Aplicar migrations localmente (Docker)
supabase db reset

# Aplicar migrations no cloud
supabase db push

# Ver status das migrations
supabase migration list
```

### ALCOA+ Compliance

**[Fonte: Epic 2 - Compliance]**

Tabelas já preparadas para compliance:
- ✅ **Atribuível:** user_id em todas as mutações
- ✅ **Contemporâneo:** timestamp_ocorrencia (não editável)
- ✅ **Original:** Audit trail será adicionado no Epic 2
- ✅ **Durável:** PostgreSQL ACID + backups Supabase

**Nota:** Tabela `ordens_producao_ativas` foi REMOVIDA - não haverá sensores no MVP.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-26 | 1.0 | História criada | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used
_A ser preenchido pelo Dev Agent_

### Debug Log References
_A ser preenchido pelo Dev Agent_

### Completion Notes
_A ser preenchido pelo Dev Agent_

### File List
_A ser preenchido pelo Dev Agent_

---

## QA Results
_A ser preenchido pelo QA Agent_
