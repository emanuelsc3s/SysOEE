# Story 001.004: API TypeScript - Supervisão de Turnos

## Status
Draft

## Story

**As a** desenvolvedor frontend,
**I want** uma API TypeScript com endpoints para buscar turnos, detalhes de apontamentos e fechar turnos,
**so that** a página de supervisão possa consumir dados e executar ações através de funções tipadas e testadas.

## Acceptance Criteria

1. Arquivo `src/services/api/supervisao.api.ts` criado com exports de todas as funções
2. Arquivo `src/types/supervisao.ts` criado com todos os tipos TypeScript necessários
3. Function `buscarTurnosDoDia(filtros: FiltroSupervisao): Promise<TurnoSupervisao[]>` implementada buscando de vw_supervisao_turnos
4. Function `buscarDetalhesApontamentos(lote_id: string): Promise<DetalheApontamentos>` implementada buscando paradas, produção e qualidade com JOINs
5. Function `fecharTurno(lote_id: string, supervisor_id: number, observacoes?: string): Promise<ResultadoFechamentoTurno>` implementada executando UPDATE em tblote e RPC para inserir_snapshot_oee
6. Function `reabrirTurno(lote_id: string, supervisor_id: number, motivo: string): Promise<void>` implementada invalidando OEE e reabrindo lote
7. Function `buscarResumoTurnos(data: string): Promise<ResumoTurnos>` implementada contando total/abertos/fechados
8. Todos os tipos TypeScript mapeiam corretamente estrutura do banco (linhaproducao_id como number, não string)
9. Erros do Supabase são tratados e re-lançados com mensagens claras
10. Todas as queries usam `eq('deletado', 'N')` para filtrar registros não deletados
11. Código segue padrões do projeto (docs/architecture/coding-standards.md)
12. Testes manuais com Supabase local executados com sucesso

## Tasks / Subtasks

- [ ] Criar arquivo de tipos (AC: 2, 8)
  - [ ] Criar src/types/supervisao.ts
  - [ ] Definir interface TurnoSupervisao (mapear view vw_supervisao_turnos)
  - [ ] Definir interface FiltroSupervisao (data, linhaproducao_id?, departamento_id?, status?)
  - [ ] Definir interface DetalheApontamentos (paradas, producao, qualidade arrays)
  - [ ] Definir interface ApontamentoParada com nested types (codigo_parada, operador.funcionario.nome)
  - [ ] Definir interface ApontamentoProducao
  - [ ] Definir interface ApontamentoQualidade
  - [ ] Definir interface ResultadoFechamentoTurno
  - [ ] Definir interface ResumoTurnos

- [ ] Criar arquivo de API (AC: 1)
  - [ ] Criar src/services/api/supervisao.api.ts
  - [ ] Import { supabase } from '@/lib/supabase'
  - [ ] Import types from '@/types/supervisao'

- [ ] Implementar buscarTurnosDoDia (AC: 3, 10)
  - [ ] Function signature conforme AC
  - [ ] supabase.from('vw_supervisao_turnos').select('*')
  - [ ] Aplicar filtro .eq('data_producao', filtros.data)
  - [ ] If filtros.linhaproducao_id, aplicar .eq()
  - [ ] If filtros.departamento_id, aplicar .eq()
  - [ ] If filtros.status, aplicar .eq('turno_status', filtros.status)
  - [ ] .order('linhaproducao_id').order('turno_codigo')
  - [ ] Tratamento de erro: if (error) throw new Error(...)
  - [ ] Return data || []

- [ ] Implementar buscarDetalhesApontamentos (AC: 4, 10)
  - [ ] Function signature conforme AC
  - [ ] Buscar paradas: supabase.from('tbapontamentoparada').select com nested select de codigo_parada e operador
  - [ ] .eq('lote_id', lote_id).eq('deletado', 'N')
  - [ ] .order('data_parada').order('hora_inicio')
  - [ ] Buscar produção: similar com nested select de usuario
  - [ ] Buscar qualidade: similar
  - [ ] Return { paradas, producao, qualidade }
  - [ ] Tratamento de erro para cada query

- [ ] Implementar fecharTurno (AC: 5, 9)
  - [ ] Function signature conforme AC
  - [ ] Step 1: UPDATE tblote SET status='CONCLUIDO', conferido_por_supervisor, conferido_em, observacoes, updated_at, updated_by
  - [ ] .eq('lote_id', lote_id)
  - [ ] If error, throw
  - [ ] Step 2: supabase.rpc('inserir_snapshot_oee', { p_lote_id: lote_id })
  - [ ] If error, throw (incluir mensagem original do erro)
  - [ ] Return { sucesso: true, lote_id, oee_id: data?.oee_id, mensagem: '...' }

- [ ] Implementar reabrirTurno (AC: 6)
  - [ ] Function signature conforme AC
  - [ ] Step 1: Invalidar OEE - UPDATE tboee SET status='INVALIDADO', invalidado_em, invalidado_por, invalidado_motivo
  - [ ] .eq('lote_id', lote_id).eq('status', 'ATIVO')
  - [ ] Step 2: Reabrir lote - UPDATE tblote SET status='EM_ANDAMENTO', conferido_por_supervisor=null, conferido_em=null
  - [ ] Tratamento de erro

- [ ] Implementar buscarResumoTurnos (AC: 7)
  - [ ] Function signature conforme AC
  - [ ] supabase.from('vw_supervisao_turnos').select('turno_status').eq('data_producao', data)
  - [ ] Contar total: data?.length || 0
  - [ ] Contar abertos: filter(t => t.turno_status === 'ABERTO').length
  - [ ] Contar fechados: filter(t => t.turno_status === 'FECHADO').length
  - [ ] Return { total, abertos, fechados }

- [ ] Adicionar tratamento de erros (AC: 9)
  - [ ] Capturar erros do Supabase
  - [ ] Lançar exceção com mensagem clara (ex: "Erro ao buscar turnos: " + error.message)
  - [ ] Incluir contexto (lote_id, data, etc.) na mensagem de erro

- [ ] Validar contra padrões do projeto (AC: 11)
  - [ ] Verificar naming conventions
  - [ ] Verificar que tipos estão corretos
  - [ ] Verificar que async/await está usado corretamente
  - [ ] Verificar imports

- [ ] Testar manualmente (AC: 12)
  - [ ] Import functions em arquivo de teste
  - [ ] Testar buscarTurnosDoDia com data de hoje
  - [ ] Testar buscarDetalhesApontamentos com lote_id válido
  - [ ] Testar buscarResumoTurnos
  - [ ] Validar que tipos TypeScript não dão erro de compilação
  - [ ] Se possível, testar fecharTurno (requer lote aberto)

## Dev Notes

### Relevant Source Tree
```
src/
├── lib/
│   └── supabase.ts                       # Supabase client (já existe)
├── services/api/
│   ├── parada.api.ts                     # Exemplo existente
│   └── supervisao.api.ts                 # ⭐ ESTE ARQUIVO (a ser criado)
└── types/
    ├── parada.ts                         # Exemplo existente
    └── supervisao.ts                     # ⭐ ESTE ARQUIVO (a ser criado)
```

### Supabase Client Usage

**Import:**
```typescript
import { supabase } from '@/lib/supabase';
```

**Query Patterns:**
```typescript
// Simple select
const { data, error } = await supabase
  .from('vw_supervisao_turnos')
  .select('*')
  .eq('data_producao', '2025-11-16');

// Select with nested relations
const { data, error } = await supabase
  .from('tbapontamentoparada')
  .select(`
    *,
    codigo_parada:tbcodigoparada(codigo, descricao, tipo_parada),
    operador:tbusuario!criado_por_operador(
      usuario_id,
      login,
      funcionario:tbfuncionario(nome)
    )
  `)
  .eq('lote_id', lote_id);

// Update
const { error } = await supabase
  .from('tblote')
  .update({ status: 'CONCLUIDO', updated_at: new Date().toISOString() })
  .eq('lote_id', lote_id);

// RPC (call function)
const { data, error } = await supabase.rpc('inserir_snapshot_oee', {
  p_lote_id: lote_id
});
```

### Type Mapping (Database → TypeScript)

| Database | TypeScript |
|----------|------------|
| INTEGER | number |
| TEXT | string |
| BOOLEAN | boolean |
| TIMESTAMP | string (ISO 8601) |
| UUID | string |
| NUMERIC(10,2) | number |

### Error Handling Pattern

```typescript
export const buscarTurnosDoDia = async (filtros: FiltroSupervisao) => {
  let query = supabase.from('vw_supervisao_turnos').select('*');

  // Apply filters...

  const { data, error } = await query;

  if (error) {
    throw new Error(`Erro ao buscar turnos do dia ${filtros.data}: ${error.message}`);
  }

  return data || [];
};
```

### Nested Select Syntax

Para buscar dados de tabelas relacionadas com JOIN:

```typescript
.select(`
  *,
  codigo_parada:tbcodigoparada(
    codigo,
    descricao,
    tipo_parada
  ),
  operador:tbusuario!criado_por_operador(
    usuario_id,
    login,
    funcionario:tbfuncionario(nome)
  )
`)
```

**Importante:** O `!criado_por_operador` especifica qual FK usar quando há múltiplas FKs para a mesma tabela.

### Important Notes from Previous Work
- Padrão de API já estabelecido em `parada.api.ts`
- Tipos já estabelecidos em `parada.ts`
- Supabase client já configurado
- Convenção de export individual (export const funcao) não default export

### Testing Standards

**Manual Testing Checklist:**

1. **Compile-time:**
   - [ ] `npm run build` executa sem erros TypeScript
   - [ ] Imports resolvem corretamente
   - [ ] Tipos estão todos corretos

2. **Runtime (via console ou teste manual):**
   ```typescript
   import { buscarTurnosDoDia } from '@/services/api/supervisao.api';

   // Test 1
   const turnos = await buscarTurnosDoDia({
     data: '2025-11-16'
   });
   console.log('Turnos:', turnos);

   // Test 2
   const detalhes = await buscarDetalhesApontamentos('uuid-lote');
   console.log('Paradas:', detalhes.paradas.length);

   // Test 3
   const resumo = await buscarResumoTurnos('2025-11-16');
   console.log('Total:', resumo.total, 'Abertos:', resumo.abertos);
   ```

3. **Error Cases:**
   - [ ] Chamar função com lote_id inválido → deve lançar erro claro
   - [ ] Chamar fecharTurno sem velocidade cadastrada → deve propagar erro da function
   - [ ] Network offline → deve lançar erro

4. **Type Safety:**
   - [ ] Tentar passar filtros com tipo errado → TypeScript deve rejeitar
   - [ ] Tentar acessar campo inexistente em TurnoSupervisao → TypeScript deve rejeitar

## Change Log

| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-11-16 | 1.0     | Story criada                         | Sarah  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
