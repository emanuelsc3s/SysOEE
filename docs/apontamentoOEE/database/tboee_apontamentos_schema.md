# Documenta√ß√£o T√©cnica: Tabelas de Apontamento OEE

**Projeto**: Sistema OEE para SicFar
**Vers√£o**: 1.0
**Data**: 2025-12-17
**Autor**: Emanuel Silva

---

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Diagrama de Relacionamentos](#diagrama-de-relacionamentos)
3. [Tabela: tboee_producao](#tabela-tboee_producao)
4. [Tabela: tboee_paradas](#tabela-tboee_paradas)
5. [Tabela: tboee_perdas](#tabela-tboee_perdas)
6. [√çndices e Performance](#√≠ndices-e-performance)
7. [Princ√≠pios ALCOA+](#princ√≠pios-alcoa)
8. [Ordem de Cria√ß√£o](#ordem-de-cria√ß√£o)

---

## 1. Vis√£o Geral

### Objetivo

Estas tabelas armazenam os apontamentos de produ√ß√£o, paradas e perdas de qualidade que alimentam o c√°lculo do OEE (Overall Equipment Effectiveness) para a ind√∫stria farmac√™utica Farmace.

### Contexto Regulat√≥rio

- **Ind√∫stria**: Farmac√™utica (sujeita a BPF - Boas Pr√°ticas de Fabrica√ß√£o)
- **Valida√ß√£o**: Sistema ser√° validado formalmente (QI, QO, QP)
- **Princ√≠pios ALCOA+**: Todos os dados seguem princ√≠pios de integridade de dados farmac√™uticos

### Escopo MVP

- **37 linhas de produ√ß√£o** em 4 setores
- **Implanta√ß√£o**: Janeiro/2026
- **Usu√°rios simult√¢neos**: At√© 100 operadores

---

## 2. Diagrama de Relacionamentos

```
tboee_turno (cabe√ßalho do turno - j√° existe)
    ‚îÇ
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< tboee_producao (1:N)
    ‚îÇ             ‚îÇ
    ‚îÇ             ‚îÇ
    ‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< tboee_perdas (1:N)
    ‚îÇ
    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< tboee_paradas (1:N)
```

### Hierarquia de Dados

1. **Cabe√ßalho**: `tboee_turno` - Um registro por turno/data/produto
2. **Produ√ß√£o**: `tboee_producao` - N registros (um por intervalo de tempo)
3. **Qualidade**: `tboee_perdas` - N registros (vinculados a apontamentos de produ√ß√£o)
4. **Paradas**: `tboee_paradas` - N registros (independentes de produ√ß√£o)

---

## 3. Tabela: tboee_producao

### Descri√ß√£o

Registra apontamentos de produ√ß√£o por intervalo de tempo durante o turno OEE. Cada linha representa um per√≠odo de produ√ß√£o com in√≠cio, fim e quantidade produzida.

### Estrutura da Tabela

```sql
CREATE TABLE public.tboee_producao (
  -- Chave prim√°ria
  producao_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,

  -- Relacionamentos
  oeeturno_id BIGINT NOT NULL,
  linha_id INTEGER NOT NULL,
  produto_id INTEGER NOT NULL,
  turno_id INTEGER NOT NULL,

  -- Dados do apontamento
  data_apontamento DATE NOT NULL,
  hora_inicio TIME WITHOUT TIME ZONE NOT NULL,
  hora_fim TIME WITHOUT TIME ZONE NULL,

  -- M√©tricas de produ√ß√£o
  quantidade_produzida INTEGER NOT NULL,
  velocidade_nominal DECIMAL(10,2) NOT NULL,
  tempo_operacao DECIMAL(10,2) NOT NULL,
  tempo_disponivel DECIMAL(10,2) NOT NULL,

  -- Dados descritivos (desnormaliza√ß√£o)
  linha_nome TEXT NOT NULL,
  setor TEXT NOT NULL,
  sku_codigo TEXT NOT NULL,
  produto_descricao TEXT NOT NULL,
  turno_nome TEXT NOT NULL,

  -- Auditoria ALCOA+
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (NOW() AT TIME ZONE 'America/Fortaleza'),
  created_by INTEGER NULL,
  updated_at TIMESTAMP WITHOUT TIME ZONE NULL,
  updated_by INTEGER NULL,
  deleted_at TIMESTAMP WITHOUT TIME ZONE NULL,
  deleted_by INTEGER NULL,
  deletado TEXT NULL DEFAULT 'N',

  -- Constraints
  CONSTRAINT tboee_producao_pkey PRIMARY KEY (producao_id),
  CONSTRAINT tboee_producao_oeeturno_id_fkey FOREIGN KEY (oeeturno_id)
    REFERENCES tboee_turno (oeeturno_id),
  CONSTRAINT tboee_producao_linha_id_fkey FOREIGN KEY (linha_id)
    REFERENCES tblinha (linhaid),
  CONSTRAINT tboee_producao_produto_id_fkey FOREIGN KEY (produto_id)
    REFERENCES tbproduto (produto_id),
  CONSTRAINT tboee_producao_turno_id_fkey FOREIGN KEY (turno_id)
    REFERENCES tbturno (turno_id),
  CONSTRAINT tboee_producao_created_by_fkey FOREIGN KEY (created_by)
    REFERENCES tbusuario (usuario_id),
  CONSTRAINT tboee_producao_updated_by_fkey FOREIGN KEY (updated_by)
    REFERENCES tbusuario (usuario_id),
  CONSTRAINT tboee_producao_deleted_by_fkey FOREIGN KEY (deleted_by)
    REFERENCES tbusuario (usuario_id),

  -- Valida√ß√µes
  CONSTRAINT tboee_producao_quantidade_check CHECK (quantidade_produzida >= 0),
  CONSTRAINT tboee_producao_velocidade_check CHECK (velocidade_nominal > 0),
  CONSTRAINT tboee_producao_tempo_operacao_check CHECK (tempo_operacao >= 0),
  CONSTRAINT tboee_producao_deletado_check CHECK (deletado IN ('S', 'N'))
) TABLESPACE pg_default;
```

### Campos Principais

| Campo | Tipo | Descri√ß√£o | Obrigat√≥rio | Observa√ß√µes |
|-------|------|-----------|-------------|-------------|
| `producao_id` | BIGINT | Chave prim√°ria auto-incremento | Sim | Identificador √∫nico |
| `oeeturno_id` | BIGINT | FK para cabe√ßalho do turno | Sim | Vincula ao turno OEE |
| `linha_id` | INTEGER | FK para linha de produ√ß√£o | Sim | Qual linha produziu |
| `produto_id` | INTEGER | FK para produto | Sim | Qual produto foi fabricado |
| `turno_id` | INTEGER | FK para turno | Sim | Qual turno (D1, D2, N1) |
| `data_apontamento` | DATE | Data do apontamento | Sim | Formato YYYY-MM-DD |
| `hora_inicio` | TIME | Hora de in√≠cio do per√≠odo | Sim | Formato HH:MM:SS |
| `hora_fim` | TIME | Hora de fim do per√≠odo | N√£o | NULL se produ√ß√£o em andamento |
| `quantidade_produzida` | INTEGER | Unidades produzidas | Sim | >= 0 unidades |
| `velocidade_nominal` | DECIMAL(10,2) | Velocidade do SKU | Sim | unidades/hora (> 0) |
| `tempo_operacao` | DECIMAL(10,2) | Tempo de opera√ß√£o | Sim | Horas (calculado) |
| `tempo_disponivel` | DECIMAL(10,2) | Tempo dispon√≠vel | Sim | Horas (geralmente 12h) |

### Campos Descritivos (Desnormalizados)

| Campo | Tipo | Descri√ß√£o | Justificativa |
|-------|------|-----------|---------------|
| `linha_nome` | TEXT | Nome da linha | Performance em consultas |
| `setor` | TEXT | Setor produtivo | Evitar JOIN em relat√≥rios |
| `sku_codigo` | TEXT | C√≥digo do SKU | Hist√≥rico imut√°vel (ALCOA+) |
| `produto_descricao` | TEXT | Descri√ß√£o do produto | Rastreabilidade |
| `turno_nome` | TEXT | Nome do turno | Legibilidade |

**Importante**: A desnormaliza√ß√£o √© proposital para:
- ‚ö° Melhorar performance de consultas de OEE
- üìú Manter hist√≥rico imut√°vel (se linha mudar nome, registro mant√©m original)
- üìä Facilitar relat√≥rios sem m√∫ltiplos JOINs

### √çndices

```sql
-- Busca por turno OEE
CREATE INDEX idx_oee_producao_oeeturno
  ON tboee_producao(oeeturno_id)
  WHERE deletado = 'N';

-- Busca por data e turno (relat√≥rios di√°rios)
CREATE INDEX idx_oee_producao_data_turno
  ON tboee_producao(data_apontamento, turno_id)
  WHERE deletado = 'N';

-- Busca por linha e SKU (c√°lculo OEE por linha)
CREATE INDEX idx_oee_producao_linha_sku
  ON tboee_producao(linha_id, sku_codigo)
  WHERE deletado = 'N';

-- Ordena√ß√£o cronol√≥gica
CREATE INDEX idx_oee_producao_created_at
  ON tboee_producao(created_at);
```

### Coment√°rios SQL

```sql
COMMENT ON TABLE tboee_producao IS
  'Apontamentos de produ√ß√£o por intervalo de tempo durante o turno OEE';

COMMENT ON COLUMN tboee_producao.oeeturno_id IS
  'Relacionamento com cabe√ßalho do turno OEE';

COMMENT ON COLUMN tboee_producao.quantidade_produzida IS
  'Quantidade produzida no per√≠odo (unidades)';

COMMENT ON COLUMN tboee_producao.velocidade_nominal IS
  'Velocidade nominal do SKU em unidades/hora';

COMMENT ON COLUMN tboee_producao.tempo_operacao IS
  'Tempo de opera√ß√£o do per√≠odo em horas (hora_fim - hora_inicio)';
```

### Exemplo de Uso

```sql
-- Inserir novo apontamento de produ√ß√£o
INSERT INTO tboee_producao (
  oeeturno_id, linha_id, produto_id, turno_id,
  data_apontamento, hora_inicio, hora_fim,
  quantidade_produzida, velocidade_nominal, tempo_operacao, tempo_disponivel,
  linha_nome, setor, sku_codigo, produto_descricao, turno_nome,
  created_by
) VALUES (
  123,                    -- ID do turno OEE
  15,                     -- ID da linha (SPEP - Linha E)
  456,                    -- ID do produto
  1,                      -- ID do turno (D1)
  '2026-01-15',          -- Data
  '07:00:00',            -- In√≠cio
  '08:00:00',            -- Fim
  9500,                  -- Quantidade produzida
  10000.00,              -- Velocidade nominal
  1.00,                  -- Tempo de opera√ß√£o (1 hora)
  12.00,                 -- Tempo dispon√≠vel (12 horas)
  'SPEP 2 - LINHA E - ENVASE',
  'SPEP',
  '07010001',
  'SOL. CLORETO DE SODIO 0,9% 500ML',
  'D1 - Diurno',
  1                      -- ID do usu√°rio
);
```

---

## 4. Tabela: tboee_paradas

### Descri√ß√£o

Registra paradas de produ√ß√£o classificadas em tr√™s tipos: **Estrat√©gicas**, **Planejadas** e **N√£o Planejadas**. Paradas afetam o componente **Disponibilidade** do OEE.

### Estrutura da Tabela

```sql
CREATE TABLE public.tboee_paradas (
  -- Chave prim√°ria
  parada_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,

  -- Relacionamentos
  oeeturno_id BIGINT NOT NULL,
  linha_id INTEGER NOT NULL,
  turno_id INTEGER NOT NULL,
  codigoparada_id INTEGER NULL,
  lote_id INTEGER NULL,

  -- Dados da parada
  data_parada DATE NOT NULL,
  hora_inicio TIME WITHOUT TIME ZONE NOT NULL,
  hora_fim TIME WITHOUT TIME ZONE NULL,
  duracao_minutos INTEGER NULL,

  -- Classifica√ß√£o da parada
  tipo_parada TEXT NOT NULL,
  codigo_parada TEXT NOT NULL,
  descricao_parada TEXT NOT NULL,
  impacta_disponibilidade BOOLEAN DEFAULT TRUE,

  -- Dados descritivos
  linha_nome TEXT NOT NULL,
  turno_nome TEXT NOT NULL,
  observacao TEXT NULL,

  -- Confer√™ncia (ALCOA+)
  conferido_por_supervisor INTEGER NULL,
  conferido_em TIMESTAMP WITHOUT TIME ZONE NULL,

  -- Auditoria ALCOA+
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (NOW() AT TIME ZONE 'America/Fortaleza'),
  created_by INTEGER NULL,
  updated_at TIMESTAMP WITHOUT TIME ZONE NULL,
  updated_by INTEGER NULL,
  deleted_at TIMESTAMP WITHOUT TIME ZONE NULL,
  deleted_by INTEGER NULL,
  deletado TEXT NULL DEFAULT 'N',

  -- Constraints
  CONSTRAINT tboee_paradas_pkey PRIMARY KEY (parada_id),
  CONSTRAINT tboee_paradas_oeeturno_id_fkey FOREIGN KEY (oeeturno_id)
    REFERENCES tboee_turno (oeeturno_id),
  CONSTRAINT tboee_paradas_linha_id_fkey FOREIGN KEY (linha_id)
    REFERENCES tblinha (linhaid),
  CONSTRAINT tboee_paradas_turno_id_fkey FOREIGN KEY (turno_id)
    REFERENCES tbturno (turno_id),
  CONSTRAINT tboee_paradas_codigoparada_id_fkey FOREIGN KEY (codigoparada_id)
    REFERENCES tbcodigoparada (codigoparada_id),
  CONSTRAINT tboee_paradas_lote_id_fkey FOREIGN KEY (lote_id)
    REFERENCES tblote (lote_id),
  CONSTRAINT tboee_paradas_conferido_por_fkey FOREIGN KEY (conferido_por_supervisor)
    REFERENCES tbusuario (usuario_id),
  CONSTRAINT tboee_paradas_created_by_fkey FOREIGN KEY (created_by)
    REFERENCES tbusuario (usuario_id),
  CONSTRAINT tboee_paradas_updated_by_fkey FOREIGN KEY (updated_by)
    REFERENCES tbusuario (usuario_id),
  CONSTRAINT tboee_paradas_deleted_by_fkey FOREIGN KEY (deleted_by)
    REFERENCES tbusuario (usuario_id),

  -- Valida√ß√µes
  CONSTRAINT tboee_paradas_tipo_check CHECK (tipo_parada IN ('ESTRATEGICA', 'PLANEJADA', 'NAO_PLANEJADA')),
  CONSTRAINT tboee_paradas_duracao_check CHECK (duracao_minutos IS NULL OR duracao_minutos >= 0),
  CONSTRAINT tboee_paradas_deletado_check CHECK (deletado IN ('S', 'N'))
) TABLESPACE pg_default;
```

### Campos Principais

| Campo | Tipo | Descri√ß√£o | Obrigat√≥rio | Observa√ß√µes |
|-------|------|-----------|-------------|-------------|
| `parada_id` | BIGINT | Chave prim√°ria auto-incremento | Sim | Identificador √∫nico |
| `oeeturno_id` | BIGINT | FK para cabe√ßalho do turno | Sim | Vincula ao turno OEE |
| `linha_id` | INTEGER | FK para linha de produ√ß√£o | Sim | Linha que parou |
| `turno_id` | INTEGER | FK para turno | Sim | Turno da parada |
| `codigoparada_id` | INTEGER | FK para c√≥digo de parada | N√£o | NULL se n√£o cadastrado |
| `lote_id` | INTEGER | FK para lote | N√£o | NULL se parada sem lote |
| `data_parada` | DATE | Data da parada | Sim | Formato YYYY-MM-DD |
| `hora_inicio` | TIME | Hora de in√≠cio da parada | Sim | Formato HH:MM:SS |
| `hora_fim` | TIME | Hora de fim da parada | N√£o | NULL se em andamento |
| `duracao_minutos` | INTEGER | Dura√ß√£o em minutos | N√£o | Calculado automaticamente |

### Classifica√ß√£o de Paradas

| Campo | Tipo | Descri√ß√£o | Valores Poss√≠veis |
|-------|------|-----------|-------------------|
| `tipo_parada` | TEXT | Tipo da parada | 'ESTRATEGICA', 'PLANEJADA', 'NAO_PLANEJADA' |
| `codigo_parada` | TEXT | C√≥digo da parada | C√≥digo alfanum√©rico |
| `descricao_parada` | TEXT | Descri√ß√£o da parada | Texto livre |
| `impacta_disponibilidade` | BOOLEAN | Se afeta Disponibilidade | TRUE (parada) ou FALSE (Performance) |

**Importante sobre `impacta_disponibilidade`**:
- `TRUE` (padr√£o): Parada >= 10 minutos, afeta **Disponibilidade**
- `FALSE`: Parada < 10 minutos (pequena parada), afeta **Performance**

### Tipos de Parada (Metodologia OEE)

| Tipo | Descri√ß√£o | Entra no c√°lculo OEE? | Exemplo |
|------|-----------|----------------------|---------|
| **ESTRATEGICA** | Decis√£o da gest√£o, n√£o afeta OEE | ‚ùå **N√ÉO** | Parada para alinhamento de estoque |
| **PLANEJADA** | Manuten√ß√£o preventiva programada | ‚úÖ Sim (reduz Disponibilidade) | Setup, limpeza programada |
| **NAO_PLANEJADA** | Falhas e imprevistos | ‚úÖ Sim (reduz Disponibilidade) | Quebra de m√°quina, falta de insumo |

### Confer√™ncia e Auditoria

| Campo | Tipo | Descri√ß√£o | ALCOA+ |
|-------|------|-----------|--------|
| `conferido_por_supervisor` | INTEGER | ID do supervisor | Atribu√≠vel |
| `conferido_em` | TIMESTAMP | Data/hora da confer√™ncia | Contempor√¢neo |
| `observacao` | TEXT | Detalhes adicionais | Completo |

### √çndices

```sql
-- Busca por turno OEE
CREATE INDEX idx_oee_paradas_oeeturno
  ON tboee_paradas(oeeturno_id)
  WHERE deletado = 'N';

-- Busca por data e turno
CREATE INDEX idx_oee_paradas_data_turno
  ON tboee_paradas(data_parada, turno_id)
  WHERE deletado = 'N';

-- Busca por linha (c√°lculo OEE)
CREATE INDEX idx_oee_paradas_linha
  ON tboee_paradas(linha_id)
  WHERE deletado = 'N';

-- Busca por tipo de parada
CREATE INDEX idx_oee_paradas_tipo
  ON tboee_paradas(tipo_parada)
  WHERE deletado = 'N';

-- Busca por c√≥digo de parada
CREATE INDEX idx_oee_paradas_codigo
  ON tboee_paradas(codigo_parada)
  WHERE deletado = 'N';

-- Ordena√ß√£o cronol√≥gica
CREATE INDEX idx_oee_paradas_created_at
  ON tboee_paradas(created_at);
```

### Coment√°rios SQL

```sql
COMMENT ON TABLE tboee_paradas IS
  'Apontamentos de paradas de produ√ß√£o (estrat√©gicas, planejadas e n√£o planejadas)';

COMMENT ON COLUMN tboee_paradas.duracao_minutos IS
  'Dura√ß√£o da parada em minutos (calculado automaticamente)';

COMMENT ON COLUMN tboee_paradas.impacta_disponibilidade IS
  'Se FALSE, parada afeta Performance (paradas < 10 min)';

COMMENT ON COLUMN tboee_paradas.tipo_parada IS
  'ESTRATEGICA (n√£o entra no OEE) | PLANEJADA (reduz Disponibilidade) | NAO_PLANEJADA (reduz Disponibilidade)';

COMMENT ON COLUMN tboee_paradas.conferido_por_supervisor IS
  'ID do supervisor que conferiu a parada (ALCOA+: Atribu√≠vel)';
```

### Exemplo de Uso

```sql
-- Inserir nova parada n√£o planejada
INSERT INTO tboee_paradas (
  oeeturno_id, linha_id, turno_id, codigoparada_id,
  data_parada, hora_inicio, hora_fim, duracao_minutos,
  tipo_parada, codigo_parada, descricao_parada, impacta_disponibilidade,
  linha_nome, turno_nome, observacao,
  created_by
) VALUES (
  123,                    -- ID do turno OEE
  15,                     -- ID da linha
  1,                      -- ID do turno
  45,                     -- ID do c√≥digo de parada
  '2026-01-15',          -- Data
  '09:30:00',            -- In√≠cio
  '10:15:00',            -- Fim
  45,                    -- Dura√ß√£o: 45 minutos
  'NAO_PLANEJADA',       -- Tipo
  'MAQ-001',             -- C√≥digo
  'Quebra do motor principal',
  TRUE,                  -- Afeta Disponibilidade
  'SPEP 2 - LINHA E - ENVASE',
  'D1 - Diurno',
  'Substitui√ß√£o de rolamento necess√°ria',
  1                      -- ID do usu√°rio
);
```

---

## 5. Tabela: tboee_perdas

### Descri√ß√£o

Registra perdas de qualidade (unidades rejeitadas/descartadas). Perdas afetam o componente **Qualidade** do OEE, especificamente o fator **Qualidade_Unidades**.

### Estrutura da Tabela

```sql
CREATE TABLE public.tboee_perdas (
  -- Chave prim√°ria
  perdas_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,

  -- Relacionamentos
  oeeturno_id BIGINT NOT NULL,
  producao_id BIGINT NOT NULL,
  linha_id INTEGER NOT NULL,
  turno_id INTEGER NOT NULL,

  -- Dados da perda
  data_apontamento DATE NOT NULL,
  unidades_rejeitadas INTEGER NOT NULL,
  motivo_rejeicao TEXT NOT NULL,
  observacao TEXT NULL,

  -- Dados descritivos
  linha_nome TEXT NOT NULL,
  turno_nome TEXT NOT NULL,

  -- Auditoria ALCOA+
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (NOW() AT TIME ZONE 'America/Fortaleza'),
  created_by INTEGER NULL,
  updated_at TIMESTAMP WITHOUT TIME ZONE NULL,
  updated_by INTEGER NULL,
  deleted_at TIMESTAMP WITHOUT TIME ZONE NULL,
  deleted_by INTEGER NULL,
  deletado TEXT NULL DEFAULT 'N',

  -- Constraints
  CONSTRAINT tboee_perdas_pkey PRIMARY KEY (perdas_id),
  CONSTRAINT tboee_perdas_oeeturno_id_fkey FOREIGN KEY (oeeturno_id)
    REFERENCES tboee_turno (oeeturno_id),
  CONSTRAINT tboee_perdas_producao_id_fkey FOREIGN KEY (producao_id)
    REFERENCES tboee_producao (producao_id),
  CONSTRAINT tboee_perdas_linha_id_fkey FOREIGN KEY (linha_id)
    REFERENCES tblinha (linhaid),
  CONSTRAINT tboee_perdas_turno_id_fkey FOREIGN KEY (turno_id)
    REFERENCES tbturno (turno_id),
  CONSTRAINT tboee_perdas_created_by_fkey FOREIGN KEY (created_by)
    REFERENCES tbusuario (usuario_id),
  CONSTRAINT tboee_perdas_updated_by_fkey FOREIGN KEY (updated_by)
    REFERENCES tbusuario (usuario_id),
  CONSTRAINT tboee_perdas_deleted_by_fkey FOREIGN KEY (deleted_by)
    REFERENCES tbusuario (usuario_id),

  -- Valida√ß√µes
  CONSTRAINT tboee_perdas_unidades_check CHECK (unidades_rejeitadas > 0),
  CONSTRAINT tboee_perdas_deletado_check CHECK (deletado IN ('S', 'N'))
) TABLESPACE pg_default;
```

### Campos Principais

| Campo | Tipo | Descri√ß√£o | Obrigat√≥rio | Observa√ß√µes |
|-------|------|-----------|-------------|-------------|
| `perdas_id` | BIGINT | Chave prim√°ria auto-incremento | Sim | Identificador √∫nico |
| `oeeturno_id` | BIGINT | FK para cabe√ßalho do turno | Sim | Vincula ao turno OEE |
| `producao_id` | BIGINT | FK para apontamento de produ√ß√£o | Sim | Vincula √† produ√ß√£o |
| `linha_id` | INTEGER | FK para linha de produ√ß√£o | Sim | Linha que teve perda |
| `turno_id` | INTEGER | FK para turno | Sim | Turno da perda |
| `data_apontamento` | DATE | Data do apontamento | Sim | Formato YYYY-MM-DD |
| `unidades_rejeitadas` | INTEGER | Quantidade rejeitada | Sim | > 0 unidades |
| `motivo_rejeicao` | TEXT | Motivo da rejei√ß√£o | Sim | An√°lise de causa raiz |
| `observacao` | TEXT | Observa√ß√µes adicionais | N√£o | Detalhes extras |

### Relacionamento com Produ√ß√£o

**Importante**: Perdas sempre est√£o vinculadas a um apontamento de produ√ß√£o (`producao_id`). Isso permite:
- Calcular propor√ß√£o de perdas vs produ√ß√£o
- Rastrear em qual per√≠odo a perda ocorreu
- Validar consist√™ncia (perdas <= produ√ß√£o)

### √çndices

```sql
-- Busca por turno OEE
CREATE INDEX idx_oee_perdas_oeeturno
  ON tboee_perdas(oeeturno_id)
  WHERE deletado = 'N';

-- Busca por apontamento de produ√ß√£o
CREATE INDEX idx_oee_perdas_producao
  ON tboee_perdas(producao_id)
  WHERE deletado = 'N';

-- Busca por data e turno
CREATE INDEX idx_oee_perdas_data_turno
  ON tboee_perdas(data_apontamento, turno_id)
  WHERE deletado = 'N';

-- Busca por linha
CREATE INDEX idx_oee_perdas_linha
  ON tboee_perdas(linha_id)
  WHERE deletado = 'N';

-- Ordena√ß√£o cronol√≥gica
CREATE INDEX idx_oee_perdas_created_at
  ON tboee_perdas(created_at);
```

### Coment√°rios SQL

```sql
COMMENT ON TABLE tboee_perdas IS
  'Apontamentos de perdas de qualidade (unidades rejeitadas/descartadas). Afeta componente Qualidade_Unidades do OEE.';

COMMENT ON COLUMN tboee_perdas.unidades_rejeitadas IS
  'Quantidade de unidades descartadas/refugadas';

COMMENT ON COLUMN tboee_perdas.motivo_rejeicao IS
  'Motivo da rejei√ß√£o das unidades (ex: fora de especifica√ß√£o, contamina√ß√£o)';
```

### Exemplo de Uso

```sql
-- Inserir novo apontamento de perdas
INSERT INTO tboee_perdas (
  oeeturno_id, producao_id, linha_id, turno_id,
  data_apontamento, unidades_rejeitadas, motivo_rejeicao, observacao,
  linha_nome, turno_nome,
  created_by
) VALUES (
  123,                    -- ID do turno OEE
  789,                    -- ID do apontamento de produ√ß√£o
  15,                     -- ID da linha
  1,                      -- ID do turno
  '2026-01-15',          -- Data
  500,                   -- Unidades rejeitadas
  'Fora de especifica√ß√£o - pH',
  'Lote 20260115001 - pH medido: 7.8 (especifica√ß√£o: 7.0-7.4)',
  'SPEP 2 - LINHA E - ENVASE',
  'D1 - Diurno',
  1                      -- ID do usu√°rio
);
```

### Integra√ß√£o com TOTVS (ERP)

Conforme **Atividade 07** das especifica√ß√µes:

> "J√° os dados de refugo (perda de produto) seguir√£o a partir da contabiliza√ß√£o f√≠sica com total integridade de dados com as informa√ß√µes que ser√£o transcritas nos dossi√™s de produ√ß√£o e posterior apontamento de produ√ß√£o no Sistema TOTVS."

**Fluxo de Dados**:
1. ‚úÖ Operador registra perda no SicFar (`tboee_perdas`)
2. ‚úÖ Perda √© transcrita no dossi√™ de produ√ß√£o (papel)
3. ‚úÖ Perda √© apontada no TOTVS
4. üîÑ **Valida√ß√£o cruzada obrigat√≥ria**: SicFar ‚Üî TOTVS

---

## 6. √çndices e Performance

### Estrat√©gia de Indexa√ß√£o

Todos os √≠ndices seguem o padr√£o:
```sql
WHERE deletado = 'N'
```

**Benef√≠cio**: √çndices ignoram registros exclu√≠dos logicamente, melhorando performance de consultas.

### √çndices por Tabela

| Tabela | √çndice | Finalidade |
|--------|--------|------------|
| `tboee_producao` | `idx_oee_producao_oeeturno` | Buscar produ√ß√£o por turno |
| `tboee_producao` | `idx_oee_producao_data_turno` | Relat√≥rios di√°rios |
| `tboee_producao` | `idx_oee_producao_linha_sku` | C√°lculo OEE por linha |
| `tboee_paradas` | `idx_oee_paradas_oeeturno` | Buscar paradas por turno |
| `tboee_paradas` | `idx_oee_paradas_tipo` | Filtrar por tipo de parada |
| `tboee_perdas` | `idx_oee_perdas_producao` | Vincular perdas √† produ√ß√£o |

### Performance Esperada

- **Consulta de turno**: < 100ms (√≠ndice `oeeturno_id`)
- **Relat√≥rio di√°rio**: < 500ms (√≠ndice composto `data + turno`)
- **C√°lculo OEE**: < 1s (√≠ndices otimizados)

---

## 7. Princ√≠pios ALCOA+

Todas as tabelas seguem rigorosamente os princ√≠pios **ALCOA+** exigidos pela ind√∫stria farmac√™utica:

| Princ√≠pio | Implementa√ß√£o |
|-----------|---------------|
| **A**tribu√≠vel | `created_by`, `updated_by`, `deleted_by` (FK para `tbusuario`) |
| **L**eg√≠vel | Campos descritivos desnormalizados (`linha_nome`, `turno_nome`) |
| **C**ontempor√¢neo | `created_at` com timezone brasileiro (America/Fortaleza) |
| **O**riginal | Exclus√£o l√≥gica (`deletado='N'`) - nunca deletar fisicamente |
| **E**xato | Constraints de valida√ß√£o (`CHECK`) em todos os campos num√©ricos |
| **C**ompleto | Campos obrigat√≥rios marcados como `NOT NULL` |
| **C**onsistente | Foreign keys garantindo integridade referencial |
| **D**ur√°vel | Armazenamento permanente com auditoria completa |
| **D**ispon√≠vel | √çndices otimizados para consultas e auditorias |

### Exclus√£o L√≥gica (Soft Delete)

**Nunca deletar fisicamente registros!**

```sql
-- ‚ùå ERRADO
DELETE FROM tboee_producao WHERE producao_id = 123;

-- ‚úÖ CORRETO
UPDATE tboee_producao
SET
  deletado = 'S',
  deleted_at = NOW(),
  deleted_by = 1  -- ID do usu√°rio
WHERE producao_id = 123;
```

**Benef√≠cios**:
- ‚úÖ Auditoria completa (quem, quando, por qu√™)
- ‚úÖ Recupera√ß√£o de dados se necess√°rio
- ‚úÖ Conformidade com BPF e valida√ß√£o (QI, QO, QP)

---

## 8. Ordem de Cria√ß√£o

Execute os scripts DDL na seguinte ordem para respeitar as foreign keys:

### Pr√©-requisitos (j√° devem existir)
1. `tbusuario` (usu√°rios do sistema)
2. `tblinha` (linhas de produ√ß√£o)
3. `tbproduto` (produtos/SKUs)
4. `tbturno` (turnos)
5. `tbcodigoparada` (c√≥digos de parada)
6. `tblote` (lotes de produ√ß√£o)
7. `tboee_turno` (cabe√ßalho do turno OEE)

### Cria√ß√£o das Novas Tabelas
1. ‚úÖ `tboee_producao` (n√£o depende de outras novas tabelas)
2. ‚úÖ `tboee_paradas` (n√£o depende de outras novas tabelas)
3. ‚úÖ `tboee_perdas` (depende de `tboee_producao`)

### Script de Cria√ß√£o Completo

```sql
-- =====================================================
-- SCRIPT DE CRIA√á√ÉO: Tabelas de Apontamento OEE
-- Projeto: Sistema OEE para SicFar
-- Data: 2025-12-17
-- =====================================================

-- 1. Criar tboee_producao
-- (Cole aqui o DDL completo da se√ß√£o 3)

-- 2. Criar tboee_paradas
-- (Cole aqui o DDL completo da se√ß√£o 4)

-- 3. Criar tboee_perdas
-- (Cole aqui o DDL completo da se√ß√£o 5)

-- Verificar cria√ß√£o
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name LIKE 'tboee_%'
ORDER BY table_name;
```

---

## üìö Refer√™ncias

- **Especifica√ß√µes do Cliente**: `/home/emanuel/SysOEE/docs/EspecificacaoUsuario/md/`
- **Metodologia de C√°lculo**: `Atividade 05 - √öltima REV.md`
- **Fontes de Dados**: `Atividade 07 - √öltima REV.md`
- **Gloss√°rio de Termos**: `Atividade 04 - √öltima REV.md`
- **CLAUDE.md**: `/home/emanuel/SysOEE/CLAUDE.md`

---

## üìù Controle de Vers√µes

| Vers√£o | Data | Autor | Altera√ß√µes |
|--------|------|-------|------------|
| 1.0 | 2025-12-17 | Emanuel Silva | Cria√ß√£o inicial da documenta√ß√£o |

---

## ‚úÖ Checklist de Implementa√ß√£o

- [ ] Executar DDL de `tboee_producao`
- [ ] Executar DDL de `tboee_paradas`
- [ ] Executar DDL de `tboee_perdas`
- [ ] Criar servi√ßos Supabase para cada tabela
- [ ] Implementar migra√ß√£o de dados do localStorage
- [ ] Atualizar `ApontamentoOEE.tsx` para usar Supabase
- [ ] Testes de integra√ß√£o
- [ ] Valida√ß√£o com Consultor Rafael Gusm√£o
- [ ] Aprova√ß√£o de S√°vio Correia Rafael

---

**Fim da Documenta√ß√£o**
