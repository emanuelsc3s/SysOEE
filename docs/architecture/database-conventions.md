# Conven√ß√µes de Banco de Dados - SysOEE

[‚Üê Voltar para Arquitetura](./index.md)

**√öltima Atualiza√ß√£o:** 2025-11-16

---

## üìã Conven√ß√µes Gerais

### 1. Nomenclatura de Tabelas

**Padr√£o:** `tb<nome>` (lowercase)

Exemplos:
- `tbusuario` ‚úÖ
- `tblinhaproducao` ‚úÖ
- `tbdepartamento` ‚úÖ
- `tboee` ‚úÖ

**Evitar:**
- CamelCase: `tbUsuario` ‚ùå
- Prefixos mistos: `tbl_usuario` ‚ùå
- Plural: `tbusuarios` ‚ùå

---

### 2. Nomenclatura de Colunas

**Padr√£o:** `snake_case` (lowercase com underscores)

Exemplos:
- `linhaproducao_id` ‚úÖ
- `data_referencia` ‚úÖ
- `tempo_calendario_minutos` ‚úÖ
- `created_at` ‚úÖ

**Primary Keys:**
```sql
<tabela_sem_tb>_id INTEGER GENERATED BY DEFAULT AS IDENTITY
```

Exemplos:
- `tbdepartamento` ‚Üí `departamento_id` ‚úÖ
- `tblinhaproducao` ‚Üí `linhaproducao_id` ‚úÖ
- `tbusuario` ‚Üí `usuario_id` ‚úÖ
- `tboee` ‚Üí `oee_id` ‚úÖ

---

### 3. Tipos de Dados

#### 3.1. IDs

**Padr√£o:** `INTEGER GENERATED BY DEFAULT AS IDENTITY`

```sql
-- ‚úÖ PADR√ÉO DO PROJETO
funcionario_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL

-- ‚ùå N√ÉO USAR (documenta√ß√£o antiga)
id UUID PRIMARY KEY DEFAULT gen_random_uuid()
```

**Motivo:** INTEGER IDENTITY √© mais perform√°tico e simples que UUID.

#### 3.2. Texto

**Padr√£o:** `TEXT` (preferido sobre VARCHAR)

```sql
-- ‚úÖ PREFERIDO
nome TEXT
observacao TEXT
email TEXT

-- ‚ö†Ô∏è Usar VARCHAR apenas quando h√° limite de neg√≥cio
cpf VARCHAR(14)  -- Aceitar pois CPF tem tamanho fixo
cep VARCHAR(9)   -- CEP tem tamanho fixo
```

#### 3.3. Booleanos e Flags

**üéØ CONVEN√á√ÉO DO PROJETO: TEXT com valores 'Sim'/'N√£o' ou 'S'/'N'**

```sql
-- ‚úÖ PADR√ÉO DO PROJETO
ativo TEXT DEFAULT 'Sim'
bloqueado TEXT DEFAULT 'N√£o'
deletado TEXT DEFAULT 'N'
sync TEXT DEFAULT 'N'

-- ‚ùå N√ÉO USAR (documenta√ß√£o antiga)
ativo BOOLEAN DEFAULT TRUE
deletado CHAR(1) CHECK (deletado IN ('S', 'N'))
```

**Valores Aceitos:**
- **Extenso:** `'Sim'` / `'N√£o'`
- **Abreviado:** `'S'` / `'N'`

**Escolha:**
- Use extenso para campos vis√≠veis ao usu√°rio (`ativo`, `bloqueado`)
- Use abreviado para campos internos (`deletado`, `sync`)

**Queries:**
```sql
-- Filtrar ativos
WHERE ativo = 'Sim'

-- Filtrar n√£o deletados
WHERE deletado = 'N'
```

#### 3.4. Datas e Timestamps

**Data:** `DATE`
```sql
data_referencia DATE NOT NULL
data_nascimento DATE
```

**Timestamp sem timezone:** `TIMESTAMP WITHOUT TIME ZONE`
```sql
updated_at TIMESTAMP WITHOUT TIME ZONE
deleted_at TIMESTAMP WITHOUT TIME ZONE
```

**Timestamp com timezone (preferido para auditoria):** `TIMESTAMP WITH TIME ZONE`
```sql
-- ‚úÖ Preferido para campos de auditoria e c√°lculos
created_at TIMESTAMP WITH TIME ZONE DEFAULT (now() AT TIME ZONE 'America/Fortaleza')
calculado_em TIMESTAMP WITH TIME ZONE DEFAULT (now() AT TIME ZONE 'America/Fortaleza')
```

**Timezone Padr√£o:** `America/Fortaleza` (UTC-3)

#### 3.5. Num√©ricos

**Inteiros:**
```sql
INTEGER  -- Padr√£o para contadores, quantidades, IDs
SERIAL   -- Auto-incremento (alternativa a IDENTITY)
```

**Decimais:**
```sql
NUMERIC(10,2)  -- Padr√£o para valores com precis√£o (velocidade, etc)
NUMERIC(5,2)   -- Para percentuais (0.00 a 100.00)
```

---

### 4. Campos de Auditoria (ALCOA+)

**Padr√£o Obrigat√≥rio em TODAS as tabelas:**

```sql
-- Cria√ß√£o
created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (now() AT TIME ZONE 'America/Fortaleza'),
created_by INTEGER NULL REFERENCES tbusuario(usuario_id),

-- Atualiza√ß√£o
updated_at TIMESTAMP WITHOUT TIME ZONE NULL,
updated_by INTEGER NULL REFERENCES tbusuario(usuario_id),

-- Dele√ß√£o l√≥gica
deleted_at TIMESTAMP WITHOUT TIME ZONE NULL,
deleted_by INTEGER NULL REFERENCES tbusuario(usuario_id),

-- Flag de dele√ß√£o
deletado TEXT NULL DEFAULT 'N',
```

**‚ö†Ô∏è IMPORTANTE:**
- `created_at` e `created_by` s√£o **NOT NULL**
- `updated_at`, `deleted_at` s√£o **NULL** (populados apenas quando ocorrer)
- `deletado` √© TEXT ('S'/'N'), n√£o BOOLEAN

---

### 5. Campos de Integra√ß√£o

**Padr√£o para integra√ß√µes com sistemas externos (TOTVS, SICFAR):**

```sql
sync TEXT NOT NULL DEFAULT 'N',  -- 'S' = sincronizado, 'N' = pendente
sync_data TIMESTAMP WITHOUT TIME ZONE NULL
```

---

### 6. Constraints e Valida√ß√µes

#### 6.1. Primary Key

```sql
CONSTRAINT tb<nome>_pkey PRIMARY KEY (<tabela_sem_tb>_id)
```

Exemplo:
```sql
CONSTRAINT tbdepartamento_pkey PRIMARY KEY (departamento_id)
```

#### 6.2. Foreign Keys

```sql
CONSTRAINT tb<origem>_<campo>_fkey FOREIGN KEY (<campo>)
  REFERENCES tb<destino>(<destino_id>)
```

Exemplo:
```sql
CONSTRAINT tblinhaproducao_departamento_id_fkey FOREIGN KEY (departamento_id)
  REFERENCES tbdepartamento(departamento_id)
```

#### 6.3. Unique

```sql
CONSTRAINT uq_<tabela>_<campo> UNIQUE (<campo>)
```

Exemplo:
```sql
CONSTRAINT uq_oee_periodo UNIQUE (
  linhaproducao_id,
  data_referencia,
  turno_id,
  hora_inicio
)
```

#### 6.4. Checks

```sql
-- Valores positivos
CHECK (campo >= 0)

-- Ranges
CHECK (percentual >= 0 AND percentual <= 100)

-- Valida√ß√£o de texto
CHECK (deletado IN ('S', 'N'))
```

---

### 7. Campos Calculados (GENERATED ALWAYS AS)

**Uso:** Para campos que derivam de outros campos da mesma tabela

```sql
-- Exemplo: Tempo dispon√≠vel = Calend√°rio - Estrat√©gicas
tempo_disponivel_minutos INTEGER GENERATED ALWAYS AS (
  tempo_calendario_minutos - tempo_paradas_estrategicas_minutos
) STORED
```

**STORED vs VIRTUAL:**
- Use `STORED` (padr√£o do projeto) para melhor performance em queries

---

### 8. √çndices

#### 8.1. Nomenclatura

```sql
idx_<tabela>_<campo(s)>
```

Exemplos:
```sql
CREATE INDEX idx_tboee_linha_data ON tboee(linhaproducao_id, data_referencia);
CREATE INDEX idx_tbfuncionario_ativo ON tbfuncionario(ativo);
```

#### 8.2. Tipos de √çndice

**B-Tree (padr√£o):** Para buscas exatas e ranges
```sql
CREATE INDEX idx_tboee_status ON tboee(status);
```

**GIN (trigram):** Para buscas de texto (LIKE %termo%)
```sql
CREATE INDEX idx_tbfuncionario_nome ON tbfuncionario USING gin (nome gin_trgm_ops);
```

**Parcial:** Para filtros espec√≠ficos
```sql
CREATE INDEX idx_tboee_status ON tboee(status) WHERE status = 'ATIVO';
```

---

### 9. Coment√°rios (Documenta√ß√£o)

**Obrigat√≥rio:**
- Coment√°rio na tabela
- Coment√°rios em colunas n√£o √≥bvias

```sql
COMMENT ON TABLE tboee IS 'Snapshot hist√≥rico de OEE. Cada registro √© IMUT√ÅVEL (ALCOA+)';
COMMENT ON COLUMN tboee.velocidade_nominal IS 'Snapshot da velocidade nominal VIGENTE na data_referencia';
```

---

### 10. Enums

**Nomenclatura:** `<nome>_enum`

```sql
CREATE TYPE tipo_linha_enum AS ENUM ('ENVASE', 'EMBALAGEM');
CREATE TYPE tipo_parada_enum AS ENUM ('ESTRATEGICA', 'PLANEJADA', 'NAO_PLANEJADA');
```

**Uso:**
```sql
tipo tipo_linha_enum NULL
```

---

### 11. Tabelas APPEND-ONLY (Imut√°veis)

**Para:** Auditoria e dados cr√≠ticos que n√£o devem ser alterados

```sql
-- Prevenir UPDATE/DELETE
CREATE OR REPLACE RULE tboee_no_update AS
  ON UPDATE TO tboee
  DO INSTEAD NOTHING;

CREATE OR REPLACE RULE tboee_no_delete AS
  ON DELETE TO tboee
  DO INSTEAD NOTHING;
```

**Tabelas Append-Only no Projeto:**
- `tboee` (snapshot de OEE)
- `tbauditlog` (log de auditoria)

**Altera√ß√µes:** Usar campos de status
```sql
status TEXT DEFAULT 'ATIVO'  -- ATIVO, INVALIDADO, CORRIGIDO
invalidado_em TIMESTAMP WITH TIME ZONE
invalidado_por INTEGER REFERENCES tbusuario(usuario_id)
invalidado_motivo TEXT
```

---

## üìä Exemplo Completo de Tabela

```sql
-- =====================================================
-- TBEXEMPLO - Descri√ß√£o da tabela
-- =====================================================
CREATE TABLE IF NOT EXISTS tbexemplo (
  exemplo_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,

  -- Campos de neg√≥cio
  nome TEXT NOT NULL,
  descricao TEXT NULL,
  valor NUMERIC(10,2) CHECK (valor >= 0),
  ativo TEXT DEFAULT 'Sim',

  -- Foreign Keys
  departamento_id INTEGER NOT NULL REFERENCES tbdepartamento(departamento_id),

  -- Flags
  deletado TEXT NULL DEFAULT 'N',

  -- Integra√ß√£o
  sync TEXT NULL DEFAULT 'N',
  sync_data TIMESTAMP WITHOUT TIME ZONE NULL,

  -- Auditoria (ALCOA+)
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (now() AT TIME ZONE 'America/Fortaleza'),
  created_by INTEGER NULL REFERENCES tbusuario(usuario_id),
  updated_at TIMESTAMP WITHOUT TIME ZONE NULL,
  updated_by INTEGER NULL REFERENCES tbusuario(usuario_id),
  deleted_at TIMESTAMP WITHOUT TIME ZONE NULL,
  deleted_by INTEGER NULL REFERENCES tbusuario(usuario_id),

  -- Constraints
  CONSTRAINT tbexemplo_pkey PRIMARY KEY (exemplo_id),
  CONSTRAINT uq_exemplo_nome UNIQUE (nome)
);

-- Coment√°rios
COMMENT ON TABLE tbexemplo IS 'Descri√ß√£o completa da tabela';
COMMENT ON COLUMN tbexemplo.exemplo_id IS 'ID √∫nico do exemplo';

-- √çndices
CREATE INDEX idx_tbexemplo_departamento ON tbexemplo(departamento_id);
CREATE INDEX idx_tbexemplo_ativo ON tbexemplo(ativo) WHERE ativo = 'Sim';
```

---

## ‚ö†Ô∏è Desvios Conhecidos da Documenta√ß√£o Original

| Item | Documentado | Real | Motivo |
|------|-------------|------|--------|
| IDs | UUID | INTEGER IDENTITY | Performance |
| Booleanos | BOOLEAN | TEXT ('Sim'/'N√£o') | Conven√ß√£o do projeto |
| Timestamps | TIMESTAMP WITHOUT | TIMESTAMP WITH (auditoria) | Rastreabilidade |
| Deletado | CHAR(1) | TEXT | Consist√™ncia |

---

## üîó Refer√™ncias

- [PostgreSQL Naming Conventions](https://www.postgresql.org/docs/current/sql-syntax-lexical.html)
- [ALCOA+ Principles](https://www.fda.gov/regulatory-information/search-fda-guidance-documents/data-integrity-and-compliance-cgmp-guidance-industry)
- Migrations do projeto: `/database/migrations/`

---

**Documento Vivo:** Esta documenta√ß√£o ser√° atualizada conforme o projeto evolui.
