# Análise de Inconsistências - Migrations de Permissões

**Data:** 2025-02-01
**Versão:** 1.1
**Status:** ✅ CORREÇÕES APLICADAS

---

## Sumário Executivo

Após análise das estruturas reais das tabelas no banco de dados Supabase, foram identificadas **inconsistências críticas** nos arquivos de migrations criados. Este documento detalha cada problema e as correções necessárias.

---

## 1. Estruturas Reais das Tabelas (Referência)

### 1.1 tbapp
```sql
CREATE TABLE public.tbapp (
  app_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  app_nome TEXT NOT NULL,
  created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL,
  created_by UUID NULL,
  updated_at TIMESTAMP WITHOUT TIME ZONE NULL,
  updated_by UUID NULL,
  deleted_at TIMESTAMP WITHOUT TIME ZONE NULL,
  deleted_by UUID NULL,
  deletado public.deletado NULL DEFAULT 'N'::deletado,
  CONSTRAINT tbapp_pkey PRIMARY KEY (app_id)
);
```
✅ **Status:** Estrutura correta nos arquivos

---

### 1.2 tbperfil
```sql
CREATE TABLE public.tbperfil (
  perfil_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  perfil TEXT NOT NULL,
  observacao TEXT NULL,
  app_id INTEGER NULL,  -- ← Já existe!
  deletado public.deletado NOT NULL DEFAULT 'N'::deletado,
  -- ... campos de auditoria
  CONSTRAINT tbperfil_app_id_fkey FOREIGN KEY (app_id) REFERENCES tbapp(app_id)
);
```
✅ **Status:** Estrutura correta, `app_id` já existe

---

### 1.3 tbrotina ⚠️ DIVERGÊNCIAS
```sql
CREATE TABLE public.tbrotina (
  rotina_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  app_id INTEGER NOT NULL,          -- ← NOT NULL (obrigatório)
  rotina TEXT NOT NULL,
  rotulo TEXT NOT NULL,             -- ← Campo obrigatório não contemplado
  descricao TEXT NULL,
  modulo TEXT NOT NULL,
  ordem TEXT NOT NULL,              -- ← É TEXT, não INTEGER
  deletado public.deletado NOT NULL DEFAULT 'N'::deletado,
  -- ... campos de auditoria
);
```

#### Problemas identificados:

| Arquivo | Linha | Problema |
|---------|-------|----------|
| 13 | 91-160 | INSERTs não incluem `rotulo` (obrigatório) |
| 13 | 91-160 | INSERTs não incluem `app_id` (obrigatório) |
| 13 | 91-160 | INSERTs não incluem `created_by` (obrigatório) |
| 14 | 212 | `r.ativo = 'S'` - coluna `ativo` NÃO EXISTE |
| 19 | 356 | `r.ativo = 'S'` - coluna `ativo` NÃO EXISTE |
| 19 | 403 | `r.ativo = 'S'` - coluna `ativo` NÃO EXISTE |

---

### 1.4 tbperfil_rotina ⚠️ DIVERGÊNCIAS CRÍTICAS
```sql
CREATE TABLE public.tbperfil_rotina (
  perfilrotina_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,  -- ← Nome diferente
  app_id INTEGER NOT NULL,
  perfil_id INTEGER NOT NULL,
  rotina_id INTEGER NOT NULL,
  acesso public.acesso_rotina NOT NULL,  -- ← É ENUM, não VARCHAR
  deletado public.deletado NOT NULL DEFAULT 'N'::deletado,
  -- ... campos de auditoria
  -- ⚠️ NÃO TEM coluna 'rotina' (texto denormalizado)
);
```

#### Problemas identificados:

| Arquivo | Linha | Problema |
|---------|-------|----------|
| 13 | 183-185 | INSERT usa coluna `rotina` que NÃO EXISTE |
| 14 | 50 | `pr.rotina = p_rotina` - coluna `rotina` NÃO EXISTE |
| 14 | 303-304 | INSERT usa coluna `rotina` que NÃO EXISTE |
| 14 | 331-332 | Índice usa coluna `rotina` que NÃO EXISTE |
| 18 | 184-185 | Índice usa coluna `rotina` que NÃO EXISTE |
| 19 | 156 | `pr.rotina = p_rotina` - coluna `rotina` NÃO EXISTE |
| 19 | 349 | `pr.acesso = 'S'` - verificar compatibilidade com ENUM |
| 19 | 458 | INSERT usa coluna `rotina` que NÃO EXISTE |

#### Solução necessária:
Para buscar rotina por nome, fazer JOIN com `tbrotina`:
```sql
-- ERRADO:
WHERE pr.rotina = p_rotina

-- CORRETO:
INNER JOIN tbrotina r ON r.rotina_id = pr.rotina_id
WHERE r.rotina = p_rotina AND r.app_id = p_app_id
```

---

### 1.5 tbusuario_app ⚠️ DIVERGÊNCIAS CRÍTICAS
```sql
CREATE TABLE public.tbusuario_app (
  usuarioapp_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,  -- ← Nome diferente
  usuario_id INTEGER NOT NULL,
  app_id INTEGER NOT NULL,
  perfil_id INTEGER NOT NULL,
  deletado public.deletado NULL DEFAULT 'N'::deletado,
  -- ... campos de auditoria
  deleted_by TIMESTAMP WITHOUT TIME ZONE NULL,  -- ⚠️ Provavelmente erro (deveria ser UUID)

  -- ⚠️ NÃO TEM as seguintes colunas:
  -- ativo
  -- data_acesso_inicial
  -- data_ultimo_acesso
  -- observacao
);
```

#### Problemas identificados:

| Arquivo | Linha | Problema |
|---------|-------|----------|
| 18 | 195-249 | Políticas RLS usam `ua.ativo` que NÃO EXISTE |
| 19 | 42 | `ua.ativo` - coluna NÃO EXISTE |
| 19 | 43-44 | `data_acesso_inicial`, `data_ultimo_acesso` NÃO EXISTEM |
| 19 | 52, 97, 142, 220, 258, 294 | `ua.ativo = 'S'` - coluna NÃO EXISTE |
| 19 | 519 | INSERT com `data_acesso_inicial` - NÃO EXISTE |
| 19 | 524 | UPDATE com `ativo = 'S'` - NÃO EXISTE |
| 19 | 565 | UPDATE com `ativo = 'N'` - NÃO EXISTE |
| 19 | 595 | UPDATE com `data_ultimo_acesso` - NÃO EXISTE |

#### Solução necessária:
Usar apenas `deletado = 'N'` em vez de `ativo = 'S'`:
```sql
-- ERRADO:
AND ua.deletado = 'N'
AND ua.ativo = 'S'

-- CORRETO:
AND ua.deletado = 'N'
```

---

### 1.6 tbusuario
```sql
CREATE TABLE public.tbusuario (
  usuario_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  user_id UUID NULL,
  perfil_id INTEGER NULL,  -- ← Perfil legado (direto na tbusuario)
  perfil TEXT NULL,        -- ← Nome do perfil denormalizado
  deletado TEXT NULL DEFAULT 'N',  -- ← É TEXT, não ENUM
  -- ... outros campos
);
```
✅ **Status:** Estrutura correta nos arquivos

---

## 2. Tipo ENUM: acesso_rotina

O campo `tbperfil_rotina.acesso` usa o tipo customizado `public.acesso_rotina`.

**Ação necessária:** Verificar os valores do ENUM:
```sql
SELECT enum_range(NULL::acesso_rotina);
```

Se uma rotina de perfil tem acesso, sendo S=Sim | N=Não

---

## 3. Tipo ENUM: deletado

O campo `deletado` em várias tabelas usa o tipo `public.deletado`.

**Ação necessária:** Verificar os valores do ENUM:
```sql
SELECT enum_range(NULL::deletado);
```

soft delete N=Não / S=Sim

---

## 4. Resumo de Correções Necessárias

### 4.1 Arquivo 13-tbrotina-tbperfil-rotina.sql

| Problema | Correção |
|----------|----------|
| Função `setup_perfil_permissions` usa coluna `rotina` | Reescrever para fazer JOIN |

### 4.2 Arquivo 14-check-user-permission.sql

| Problema | Correção |
|----------|----------|
| `pr.rotina = p_rotina` (linha 50) | Fazer JOIN com `tbrotina` |
| `r.ativo = 'S'` (linha 212) | Remover - coluna não existe |
| INSERT com coluna `rotina` (linha 303-304) | Remover coluna do INSERT |
| Índice com coluna `rotina` (linha 331-332) | Remover coluna do índice |

### 4.3 Arquivo 18-multi-app-structure.sql

| Problema | Correção |
|----------|----------|
| Criação de `tbusuario_app` com campos extras | Remover campos que não existem |
| Políticas RLS com `ua.ativo` | Usar apenas `deletado = 'N'` |
| Índice com coluna `rotina` | Remover |

### 4.4 Arquivo 19-multi-app-functions.sql

| Problema | Correção |
|----------|----------|
| `ua.ativo` em várias funções | Remover todas as referências |
| `data_acesso_inicial`, `data_ultimo_acesso` | Remover referências |
| `pr.rotina = p_rotina` | Fazer JOIN com `tbrotina` |
| `r.ativo = 'S'` | Remover |
| Função `grant_app_access` com campos extras | Ajustar INSERT |
| Função `revoke_app_access` com `ativo = 'N'` | Remover |

---

## 5. Diagrama ER Corrigido

```
┌─────────────────┐
│     tbapp       │
├─────────────────┤
│ app_id (PK)     │◄────────────────────────────────────────┐
│ app_nome        │                                         │
│ deletado        │                                         │
└─────────────────┘                                         │
        │                                                   │
        │ 1:N                                               │
        ▼                                                   │
┌─────────────────┐         ┌─────────────────┐             │
│    tbperfil     │         │   tbusuario     │             │
├─────────────────┤         ├─────────────────┤             │
│ perfil_id (PK)  │◄───┐    │ usuario_id (PK) │◄────┐       │
│ app_id (FK)     │────┼────│ user_id (UUID)  │     │       │
│ perfil          │    │    │ perfil_id (FK)  │─────┼───────┼─► (legado)
│ deletado        │    │    │ deletado        │     │       │
└─────────────────┘    │    └─────────────────┘     │       │
        │              │                            │       │
        │ 1:N          │                            │       │
        ▼              │                            │       │
┌─────────────────┐    │    ┌────────────────────────────┐  │
│    tbrotina     │    │    │      tbusuario_app         │  │
├─────────────────┤    │    ├────────────────────────────┤  │
│ rotina_id (PK)  │◄───┼────│ usuarioapp_id (PK)         │  │
│ app_id (FK)     │────┼────│ usuario_id (FK) ───────────┼──┘
│ rotina          │    │    │ app_id (FK) ───────────────┼──┘
│ rotulo          │    │    │ perfil_id (FK) ────────────┼───┐
│ modulo          │    │    │ deletado                   │   │
│ ordem (TEXT!)   │    │    │ ⚠️ SEM: ativo              │   │
│ deletado        │    │    │ ⚠️ SEM: data_acesso_inicial│   │
│ ⚠️ SEM: ativo   │    │    │ ⚠️ SEM: data_ultimo_acesso │   │
└─────────────────┘    │    └────────────────────────────┘   │
        │              │                                     │
        │ N:M          └─────────────────────────────────────┘
        ▼
┌──────────────────────────┐
│    tbperfil_rotina       │
├──────────────────────────┤
│ perfilrotina_id (PK)     │
│ app_id (FK)              │
│ perfil_id (FK)           │
│ rotina_id (FK)           │
│ acesso (ENUM!)           │
│ deletado                 │
│ ⚠️ SEM: rotina (denorm)  │
└──────────────────────────┘
```

---

## 6. Próximos Passos

1. **Valores atuais dos ENUMs** no banco de dados:
   ```sql
   SELECT enum_range(NULL::acesso_rotina);

    {
      "enum_range": "{S,N}"
    }

   SELECT enum_range(NULL::deletado);

    {
      "enum_range": "{N,S}"
    }
   
   ```

2. **Decidir** se vai adicionar colunas faltantes em `tbusuario_app`:
   - `ativo` (controle de acesso temporário)
   - `data_acesso_inicial`
   - `data_ultimo_acesso`

   não irei adicionar mais nenhum campo na tbusuario_app.

3. **Criar novos arquivos** de migrations corrigidos

---

## 7. Arquivos Afetados

| Arquivo | Status | Ação |
|---------|--------|------|
| 13-tbrotina-tbperfil-rotina.sql | ✅ CORRIGIDO | Função setup_perfil_permissions reescrita |
| 14-check-user-permission.sql | ✅ CORRIGIDO | JOINs com tbrotina, removido `ativo` |
| 15-rls-permission-policies.sql | ✅ OK | Sem alterações necessárias |
| 16-rls-tbperfil.sql | ✅ OK | Sem alterações necessárias |
| 18-multi-app-structure.sql | ✅ CORRIGIDO | Removidos campos inexistentes, índice corrigido |
| 19-multi-app-functions.sql | ✅ CORRIGIDO | Todas as funções ajustadas |
| src/hooks/usePermissions.ts | ✅ CORRIGIDO | Interface UserApp sem campos inexistentes |
| src/components/auth/PermissionGuard.tsx | ✅ CRIADO | Componente de permissão

---

**Elaborado por:** Claude
**Revisão necessária:** Desenvolvedor responsável
