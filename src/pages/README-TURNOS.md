# MÃ³dulo de Gerenciamento de Turnos

## ğŸ“‹ VisÃ£o Geral

Funcionalidade completa de CRUD (Create, Read, Update, Delete) para gerenciamento de turnos de trabalho, implementada seguindo o padrÃ£o arquitetural da documentaÃ§Ã£o de licitaÃ§Ã£o.

## ğŸ¯ Funcionalidades Implementadas

### âœ… Listagem de Turnos (`/turno`)
- Tabela completa com todos os turnos cadastrados
- Busca em tempo real por cÃ³digo ou nome do turno
- VisualizaÃ§Ã£o de horÃ¡rios (inÃ­cio, fim e duraÃ§Ã£o calculada)
- Badge colorido para meta OEE (verde â‰¥90%, azul â‰¥85%, amarelo â‰¥80%, laranja <80%)
- BotÃµes de aÃ§Ã£o: Editar e Excluir
- BotÃ£o de atualizaÃ§Ã£o manual
- ConfirmaÃ§Ã£o antes de excluir

### âœ… Cadastro/EdiÃ§Ã£o de Turno (`/turno/novo` e `/turno/:id`)
- FormulÃ¡rio completo com validaÃ§Ãµes
- Campos organizados em cards temÃ¡ticos:
  - **InformaÃ§Ãµes BÃ¡sicas**: CÃ³digo e Nome do Turno
  - **HorÃ¡rios**: Hora inÃ­cio, hora fim e duraÃ§Ã£o calculada automaticamente
  - **Meta OEE**: SeleÃ§Ã£o rÃ¡pida ou valor personalizado
- Suporte a turnos que cruzam meia-noite (ex: 22:00 - 06:00)
- ValidaÃ§Ã£o de formato de horÃ¡rio (HH:MM)
- ValidaÃ§Ã£o de meta OEE (0-100%)
- Feedback visual da duraÃ§Ã£o do turno
- ConfirmaÃ§Ã£o antes de excluir

## ğŸ—„ï¸ Estrutura do Banco de Dados

### Tabela: `tbturno`

```sql
create table public.tbturno (
  turno_id integer generated by default as identity not null,
  codigo text not null,
  turno text null,
  hora_inicio time without time zone null,
  hora_fim time without time zone null,
  deletado text null default 'N'::text,
  created_at timestamp without time zone null default (now() AT TIME ZONE 'America/Fortaleza'::text),
  created_by integer null,
  updated_at timestamp without time zone null,
  updated_by integer null,
  deleted_at timestamp without time zone null,
  deleted_by integer null,
  meta_oee numeric(10, 2) null,
  constraint tbturno_pkey primary key (turno_id),
  constraint tbturno_turno_id_key unique (turno_id),
  constraint tbturno_created_by_fkey foreign key (created_by) references tbusuario (usuario_id),
  constraint tbturno_deleted_by_fkey foreign key (deleted_by) references tbusuario (usuario_id),
  constraint tbturno_updated_by_fkey foreign key (updated_by) references tbusuario (usuario_id)
) tablespace pg_default;
```

## ğŸ”§ Arquitetura TÃ©cnica

### Arquivos Criados

```
src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ turno.ts                    # Interfaces TypeScript e funÃ§Ãµes utilitÃ¡rias
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useTurnos.ts                # Hook customizado para operaÃ§Ãµes CRUD
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ Turnos.tsx                  # PÃ¡gina de listagem
â”‚   â”œâ”€â”€ TurnosCad.tsx               # PÃ¡gina de cadastro/ediÃ§Ã£o
â”‚   â””â”€â”€ README-TURNOS.md            # Esta documentaÃ§Ã£o
â””â”€â”€ lib/
    â””â”€â”€ supabase.ts                 # Cliente Supabase (atualizado com supabaseAdmin)
```

### PadrÃ£o Arquitetural

Seguindo o padrÃ£o da documentaÃ§Ã£o de licitaÃ§Ã£o:

1. **Tipos TypeScript** (`turno.ts`)
   - `TurnoFormData`: Interface para dados do formulÃ¡rio
   - `TurnoDB`: Interface para dados do banco
   - FunÃ§Ãµes utilitÃ¡rias: validaÃ§Ã£o de horÃ¡rio, cÃ¡lculo de duraÃ§Ã£o
   - Constantes: valores iniciais, opÃ§Ãµes de meta OEE

2. **Hook Customizado** (`useTurnos.ts`)
   - `fetchTurnos()`: Busca lista com filtros opcionais
   - `fetchTurno(id)`: Busca turno especÃ­fico
   - `saveTurno(data)`: Insere ou atualiza turno
   - `deleteTurno(id)`: Soft delete
   - Mapeamento automÃ¡tico entre formulÃ¡rio e banco
   - Tratamento de erros com toast notifications

3. **PÃ¡ginas React**
   - `Turnos.tsx`: Listagem com busca e aÃ§Ãµes
   - `TurnosCad.tsx`: FormulÃ¡rio completo com validaÃ§Ãµes

## ğŸ” AutenticaÃ§Ã£o e RLS

### Service Key do Supabase

Como a tabela `tbturno` possui RLS (Row Level Security) ativada mas o sistema ainda nÃ£o utiliza autenticaÃ§Ã£o de usuÃ¡rios do Supabase, a implementaÃ§Ã£o utiliza a **SUPABASE_SERVICE_KEY** para realizar operaÃ§Ãµes administrativas.

**ConfiguraÃ§Ã£o em `.env`:**
```env
VITE_SUPABASE_URL=https://gonbyhpqnqnddqozqvhk.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Cliente Admin em `lib/supabase.ts`:**
```typescript
export const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false,
  },
})
```

âš ï¸ **IMPORTANTE**: A service key faz bypass da RLS. Em produÃ§Ã£o, deve-se:
- Nunca expor a service key no frontend
- Implementar autenticaÃ§Ã£o real de usuÃ¡rios
- Usar a anon key com RLS policies adequadas

## ğŸ“Š Campos e ValidaÃ§Ãµes

### Campos ObrigatÃ³rios
- âœ… **CÃ³digo**: Identificador Ãºnico do turno (mÃ¡x. 10 caracteres)
- âœ… **Nome do Turno**: DescriÃ§Ã£o do turno (mÃ¡x. 50 caracteres)

### Campos Opcionais
- **Hora de InÃ­cio**: Formato HH:MM (validado)
- **Hora de Fim**: Formato HH:MM (validado)
- **Meta OEE**: Percentual de 0 a 100 (padrÃ£o: 85%)

### ValidaÃ§Ãµes Implementadas
1. CÃ³digo e nome nÃ£o podem estar vazios
2. Formato de horÃ¡rio deve ser HH:MM
3. Meta OEE deve estar entre 0 e 100
4. Suporte a turnos que cruzam meia-noite

## ğŸ¨ Componentes UI Utilizados

- **shadcn/ui**: Button, Input, Label, Card, Table, Badge, Select, AlertDialog
- **lucide-react**: Ãcones (Plus, Search, Pencil, Trash2, Clock, Target, etc.)
- **react-router-dom**: NavegaÃ§Ã£o entre pÃ¡ginas
- **Toast**: NotificaÃ§Ãµes de sucesso/erro

## ğŸš€ Como Usar

### Acessar Listagem
```
Navegue para: /turno
ou
Clique em "Turnos" na pÃ¡gina inicial
```

### Criar Novo Turno
```
1. Acesse /turno
2. Clique em "Novo Turno"
3. Preencha os campos obrigatÃ³rios
4. Clique em "Salvar"
```

### Editar Turno
```
1. Na listagem, clique no botÃ£o de editar (Ã­cone de lÃ¡pis)
2. Modifique os campos desejados
3. Clique em "Salvar"
```

### Excluir Turno
```
1. Na listagem ou ediÃ§Ã£o, clique no botÃ£o de excluir (Ã­cone de lixeira)
2. Confirme a exclusÃ£o no dialog
```

## ğŸ”„ Soft Delete

Todos os registros excluÃ­dos sÃ£o marcados com `deletado = 'S'` e mantidos no banco de dados para auditoria. Os campos de auditoria sÃ£o preenchidos automaticamente:

- **CriaÃ§Ã£o**: `created_at`, `created_by`
- **AtualizaÃ§Ã£o**: `updated_at`, `updated_by`
- **ExclusÃ£o**: `deleted_at`, `deleted_by`

## ğŸ“ PrÃ³ximos Passos

- [ ] Implementar autenticaÃ§Ã£o real de usuÃ¡rios
- [ ] Migrar de service key para anon key com RLS
- [ ] Adicionar paginaÃ§Ã£o na listagem
- [ ] Implementar filtros avanÃ§ados
- [ ] Adicionar exportaÃ§Ã£o de dados (CSV/Excel)
- [ ] Implementar histÃ³rico de alteraÃ§Ãµes (audit trail)
- [ ] Adicionar validaÃ§Ã£o de conflito de horÃ¡rios entre turnos
- [ ] Implementar associaÃ§Ã£o de turnos com linhas de produÃ§Ã£o

## ğŸ› Troubleshooting

### Erro ao salvar turno
- Verifique se a `SUPABASE_SERVICE_KEY` estÃ¡ configurada no `.env`
- Verifique se a tabela `tbturno` existe no Supabase
- Verifique se a tabela `tbusuario` existe (foreign key)

### Turnos nÃ£o aparecem na listagem
- Verifique se hÃ¡ registros com `deletado = 'N'`
- Verifique o console do navegador para erros de API
- Verifique se o Supabase estÃ¡ acessÃ­vel

## ğŸ“š ReferÃªncias

- DocumentaÃ§Ã£o de LicitaÃ§Ã£o: `/docs/design/licitacao/`
- Guia de ImplementaÃ§Ã£o: `/docs/design/licitacao/11-guia-implementacao-completo.md`
- PadrÃµes de CÃ³digo: `/docs/design/licitacao/12-exemplos-codigo-completo.md`

